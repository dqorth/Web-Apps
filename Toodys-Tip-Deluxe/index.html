<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toody's TipSplit Deluxe!</title>
    <!-- SheetJS Library for XLSX Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lobster&family=Open+Sans:wght@400;700&family=Bangers&display=swap');
        :root {
            --primary-red: #E53935; --accent-black: #212121; --light-cream: #FFF9C4;
            --pure-white: #FFFFFF; --disabled-gray: #BDBDBD; --border-color: #424242;
            --font-display: 'Bangers', cursive; --font-body: 'Open Sans', sans-serif;
            --border-radius: 8px; --input-padding: 12px; --button-padding: 12px 20px;
            --box-shadow-strong: 4px 4px 0px var(--accent-black);
            --box-shadow-light: 2px 2px 0px var(--accent-black);
        }
        body {
            font-family: var(--font-body); background-color: var(--light-cream);
            background-image: radial-gradient(var(--pure-white) 1px, transparent 1px),
                              radial-gradient(var(--pure-white) 1px, var(--light-cream) 1px);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
            color: var(--accent-black); margin: 0; padding: 20px; line-height: 1.7;
        }
        h1, h2, h3, h4, h5 { font-family: var(--font-display); color: var(--primary-red); letter-spacing: normal; margin-bottom: 0.6em; }
        h1 { text-align: center; font-size: 3.5em; text-shadow: 3px 3px var(--accent-black); color: var(--pure-white); margin-bottom: 0.3em; letter-spacing: 1.5px;}
        header {
            background-color: var(--primary-red); padding: 25px 20px 15px 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin: -20px -20px 25px -20px; border-bottom: 6px solid var(--accent-black);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .app-container {
            max-width: 1300px; margin: 0 auto; padding: 25px;
            background-color: rgba(255, 255, 255, 0.92); border-radius: var(--border-radius);
            border: 3px solid var(--accent-black); box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .top-date-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--pure-white);
            border: 2px solid var(--accent-black);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-light);
            align-items: flex-end;
        }

        .section-card {
            background-color: var(--pure-white); padding: 25px; border-radius: var(--border-radius);
            border: 2px solid var(--accent-black); box-shadow: var(--box-shadow-strong); margin-bottom: 20px;
        }
        .section-card > h2:not(.collapsible-header) { 
            border-bottom: 4px dotted var(--primary-red); padding-bottom: 12px; margin-top: 0;
            font-size: 2em; letter-spacing: normal;
            display: flex; justify-content: space-between; align-items: center;
        }
        .section-card h2.collapsible-header {
            border-bottom: 4px dotted var(--primary-red); padding-bottom: 12px; margin-top: 0;
            font-size: 2em; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; user-select: none; letter-spacing: normal;
        }
        .section-card h2.collapsible-header em { 
            font-size:0.7em; font-weight:normal; margin-left:10px;
            font-family: var(--font-body); color: var(--accent-black); font-style: normal; 
        }
        .section-card h2.collapsible-header:hover { opacity: 0.85; }
        .collapse-indicator { font-size: 1.2em; font-weight: bold; margin-left: 15px; min-width: 20px; text-align: center; font-family: var(--font-body); }
        .collapsible-content { padding-top: 15px; } 

        input[type="text"], input[type="number"], input[type="time"], select {
            padding: var(--input-padding); margin-bottom: 10px; border: 2px solid var(--border-color); 
            border-radius: var(--border-radius); background-color: var(--pure-white); color: var(--accent-black);
            font-family: var(--font-body); font-size: 0.95em; width: calc(100% - 24px); box-sizing: border-box; 
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="time"]:focus, select:focus {
            outline: none; border-color: var(--primary-red); box-shadow: 0 0 8px rgba(229, 57, 53, 0.6);
        }
        label { display: block; margin-bottom: 4px; font-weight: bold; color: var(--accent-black); font-size: 1em;} 
        
        .button {
            background-color:var(--primary-red);color:var(--pure-white);border:2px solid var(--accent-black);padding:var(--button-padding);border-radius:var(--border-radius);font-family:var(--font-display);font-size:1.3em;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .15s ease-in-out;box-shadow:var(--box-shadow-light);margin-top:10px;margin-right:8px 
        }
        .button:hover { background-color: #C62828; box-shadow: 1px 1px 0px var(--accent-black); transform: translate(1px, 1px); }
        .button:disabled { background-color: var(--disabled-gray); color: #757575; cursor: not-allowed; box-shadow: none; transform: none; }
        .button.small-action-btn { font-size: 0.9em; padding: 6px 10px; margin-top: 5px; }

        .item-list { list-style: none; padding: 0; }
        .item-list li { 
            background-color:var(--light-cream);
            margin-bottom:10px;border:1px solid #E0E0E0;
            border-left:6px solid var(--primary-red);border-radius:var(--border-radius);
            display:flex; justify-content: space-between; align-items: center; 
            flex-wrap: wrap; 
            box-shadow:2px 2px 4px rgba(0,0,0,.1);
            position: relative; 
            padding: 10px 15px; 
        }

        .remove-x-btn {
            position: absolute; top: 5px; right: 5px; width: 28px; height: 28px;
            font-family: var(--font-body); font-size: 1.1em; font-weight: bold;
            line-height: 1; text-align: center; background-color: var(--primary-red);
            color: var(--pure-white); border: 2px solid var(--accent-black);
            border-radius: 50%; cursor: pointer; transition: all 0.15s ease-in-out;
            z-index: 10; display: flex; justify-content: center; align-items: center;
            box-shadow: var(--box-shadow-light); padding: 0;
        }
        .remove-x-btn:hover {
            background-color: #C62828; box-shadow: 1px 1px 0px var(--accent-black);
            transform: translate(1px, 1px);
        }
        
        #rosterListContainer {
            display: grid; 
            grid-gap: 20px; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            align-items: start; 
        }
        .roster-position-group {
            background-color: var(--pure-white); 
            padding: 15px;
            border-radius: var(--border-radius); 
            border: 2px solid var(--accent-black);
            box-shadow: var(--box-shadow-light); 
            box-sizing: border-box;
            width: 100%; 
            margin-bottom: 0; 
        }
        
        #rosterListContainer .item-list li .roster-item-main-info {
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            flex-grow: 1; 
            width: 100%; 
            flex-wrap: wrap; 
        }
        #rosterListContainer .employee-info { 
            display: flex; flex-direction: column; align-items: flex-start; 
            margin-right: 10px; 
            flex-grow: 1; 
            min-width: 0; 
            margin-bottom: 5px; 
        }
        #rosterListContainer .employee-info strong { font-size: 1.05em; font-weight: bold;}
        .roster-lineup-selectable li .employee-info strong { cursor: pointer; text-decoration: underline; color: var(--primary-red); }
        .roster-lineup-selectable li .employee-info strong:hover { color: var(--accent-black); }
        
        .shift-summary-display {
            font-size: 0.8em; color: #333; margin-top: 5px; padding: 4px 6px;
            background-color: rgba(0,0,0,0.05); border-radius: 4px; 
            border-left: 3px solid var(--accent-black);
            display: block; 
            width: 100%;    
            word-break: break-word; 
            box-sizing: border-box;
        }

        #rosterListContainer .employee-actions {
            display: flex; align-items: center; gap: 8px;
            flex-shrink: 0; 
            margin-left: 10px; 
        }
        #rosterListContainer .employee-actions .worked-today-toggle-btn {
            font-size: 0.8em; padding: 5px 8px; margin-top: 0; margin-left: 0; 
            min-width: 100px; text-align: center; border-width: 2px; border-style: solid; 
            line-height: 1.3; 
        }
        .worked-today-toggle-btn.is-not-working { background-color: #f0f0f0; color: var(--accent-black); border-color: #ccc; box-shadow: var(--box-shadow-light); }
        .worked-today-toggle-btn.is-not-working:hover { background-color: #e0e0e0; }
        .worked-today-toggle-btn.is-working { 
            background-color: #d1c4e9; color: var(--accent-black); border-color: #9575cd; box-shadow: var(--box-shadow-light);
        }
        .worked-today-toggle-btn.is-working:hover { background-color: #b39ddb; }
        .worked-today-toggle-btn.is-editing-shift { 
            background-color: var(--primary-red); color: var(--pure-white); border-color: var(--accent-black); box-shadow: var(--box-shadow-light);
        }
        .worked-today-toggle-btn.is-editing-shift:hover { background-color: #C62828; }


        .inline-shift-form-container {
            width: 100%; background-color: #f9f9f9; border: 1px dashed #ccc;
            padding: 15px; margin-top: 10px; border-radius: var(--border-radius);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .inline-shift-form-container .inline-form-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
            justify-content: flex-start;
        }
        .inline-shift-form-container .time-inputs-group,
        .inline-shift-form-container .tip-inputs-group {
            display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .inline-shift-form-container .time-inputs-group > div,
        .inline-shift-form-container .tip-inputs-group > div {
            flex: 1 1 calc(50% - 10px); box-sizing: border-box; min-width: 120px;
        }
        .inline-shift-form-container label { font-size: 0.9em; margin-bottom: 2px; display: block; }
        .inline-shift-form-container input[type="time"],
        .inline-shift-form-container input[type="number"] {
            width: 100%; padding: 8px; font-size: 0.9em; margin-bottom: 0; 
        }

        #employeeListManagement { margin-top: 25px; border-top: 2px dashed var(--border-color); padding-top: 20px; }
        #employeeListManagement h3 {
            font-family: var(--font-display); color: var(--accent-black); font-size: 1.8em; 
            margin-bottom: 10px; letter-spacing: 0.5px;
        }
        #fullEmployeeRosterContainer .item-list {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start;
        }
        #fullEmployeeRosterContainer .item-list li {
            border-left: 4px solid var(--primary-red); padding: 12px 40px 12px 15px;
            justify-content: flex-start; flex-wrap: nowrap; 
            flex: 1 1 calc(33.333% - 15px); min-width: 300px; 
            box-sizing: border-box; background-color: var(--pure-white);
        }
        #fullEmployeeRosterContainer .employee-info {
            flex-grow: 1; min-width: 100px; margin-right: 10px;
        }
         #fullEmployeeRosterContainer .employee-info strong { font-size: 1.1em; }
        #fullEmployeeRosterContainer .employee-info .roster-positions {
             font-size: 0.8em; color: #666; margin-top: 3px; display: block;
        }
        #fullEmployeeRosterContainer .employee-actions {
            display: flex; align-items: center; gap: 8px; 
            flex-shrink: 0; flex-wrap: nowrap; 
        }
        #fullEmployeeRosterContainer .button.edit-btn {
            font-size: 0.9em; padding: 5px 8px; margin-top: 0; margin-left: 0;
        }
        #addEmployeeFormWrapper {
            border: 2px dashed var(--primary-red); padding: 20px; margin-top: 20px;
            margin-bottom: 20px; border-radius: var(--border-radius); background-color: #fffaf0;
        }
        
        .date-control-group { display: flex; flex-direction: column; } 
        .date-control-group label { font-size: 0.9em; margin-bottom: 3px; }
        .date-control-group select { width: auto; min-width: 150px; padding: 8px; font-size: 0.95em; margin-bottom: 0;} 
        
        .date-display-wrapper { 
            text-align: center; 
            margin-bottom: 15px; 
        }
        .date-display { 
            font-size: 1.2em; font-weight: bold; padding: 8px; 
            background-color: #eee; border-radius: var(--border-radius); 
            border: 2px inset var(--border-color); min-width:200px; 
            text-align:center; display:inline-block; 
        }

        .data-results-table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 0.9em; }
        .data-results-table th, .data-results-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .data-results-table th { background-color: var(--primary-red); color: var(--pure-white); font-family: var(--font-display); letter-spacing: 0.5px; }
        .data-results-table tbody tr:nth-child(even) { background-color: #f8f8f8; }
        .data-results-table .detailed-tip-in-row-daily td { padding: 5px 10px !important; font-size: 0.9em; }
        .data-results-table .detailed-tip-in-row-daily.even-detail td { background-color: #f0f0f0 !important; }
        .data-results-table .detailed-tip-in-row-daily.odd-detail td { background-color: #fdfdfd !important; }

        .report-day-header { font-family:var(--font-display); font-size: 1.5em; margin-top:20px; padding-bottom:5px; border-bottom:2px solid var(--accent-black); }
        .roster-position-group .position-group-header-roster {
            font-family:var(--font-display); font-size: 1.3em; margin-top:0; 
            margin-left:0px; color: var(--accent-black); padding-bottom: 8px; 
            border-bottom: 2px dotted var(--primary-red); 
        }
        
        /* UPDATED: Weekly navigation styles for robust layout */
        .week-navigation {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            margin-top: 10px;
        }
        .week-navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        .week-navigation .button {
            margin: 0;
            font-size: 1.1em;
            padding: 8px 15px;
            letter-spacing: normal;
        }
        #currentlyViewedWeekDisplay {
            font-family: var(--font-display);
            font-size: 1.6em;
            color: var(--accent-black);
            max-width: 400px;
            width: 100%;
            text-align: center;
            padding: 5px;
            border-bottom: 2px solid var(--primary-red);
            letter-spacing: 0.5px;
        }

        .collapse-bottom-btn {
            display: block;
            margin: 20px auto 0;
            font-size: 0.9em;
            padding: 8px 15px;
            letter-spacing: normal;
            text-transform: none;
            background-color: #f0f0f0;
            color: var(--accent-black);
            border-color: #ccc;
        }

        .collapse-bottom-btn:hover {
            background-color: #e0e0e0;
        }
        
        @media (max-width: 992px) { 
            #fullEmployeeRosterContainer .item-list li {
                flex: 1 1 calc(50% - 15px); min-width: 250px;
            }
             #rosterListContainer {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .top-date-controls { flex-direction: column; align-items: stretch;}
            .top-date-controls .date-control-group select { width: 100%;}
            #rosterListContainer {
                display: block; 
            }
            .roster-position-group {
                width: 100%; 
                margin-bottom: 20px; 
            }
            #fullEmployeeRosterContainer .item-list li {
                flex: 1 1 100%; min-width: unset;
            }
            #currentlyViewedWeekDisplay {
                min-width: unset;
            }
        }
        @media (max-width: 480px) { 
            #rosterListContainer .item-list li .roster-item-main-info {
                flex-direction: column; 
                align-items: stretch; 
            }
            #rosterListContainer .employee-info {
                width: 100%; 
                margin-right: 0;
                margin-bottom: 8px; 
            }
            #rosterListContainer .employee-actions {
                width: 100%; 
                justify-content: flex-start; 
                margin-left: 0;
            }
            .data-table-container table, 
            .data-table-container thead, 
            .data-table-container tbody, 
            .data-table-container th, 
            .data-table-container td, 
            .data-table-container tr {
                display: block;
            }
            .data-table-container thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .data-table-container tr { border: 1px solid #ccc; margin-bottom: .625em;}
            .data-table-container td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50% !important; 
                text-align: right;
                white-space: normal;
            }
            .data-table-container td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                content: attr(data-label);
            }
             .data-results-table .detailed-tip-in-row-daily td,
             .data-results-table .detailed-tip-in-row-daily td:before { 
                display: block;
                padding-left: 10px !important; 
                text-align: left;
                width:auto;
                position:relative;
             }
             .data-results-table .detailed-tip-in-row-daily td:before{
                 content: ""; display:none;
             }
        }

        #addEmployeeFormWrapper #empName { margin-bottom: 6px; }
        #addEmployeeFormWrapper label[for="empName"] { font-size: 1em; } 
        #addEmployeeFormWrapper #empName { padding: 10px; margin-bottom: 10px; }
        #empPositionsContainer { display:flex;flex-wrap:wrap;gap:8px;margin-top:5px;padding:5px;border:1px solid var(--light-cream);border-radius:var(--border-radius) }
        #empPositionsContainer .position-entry-group { border: none; background-color: transparent; padding: 0; margin-bottom: 0; display: flex; flex-direction: column; align-items: stretch; }
        #empPositionsContainer .role-toggle-btn { display:inline-block;padding:6px 10px;font-size:0.9em;margin-bottom:4px;min-width:100px;text-transform:none;letter-spacing:normal;font-family:var(--font-body);width:auto;flex-grow:0;box-shadow:var(--box-shadow-light) !important;}
        .role-toggle-btn:not(.selected-role){background-color:#f0f0f0;color:var(--accent-black);border:2px solid #ccc;}
        .role-toggle-btn:not(.selected-role):hover{background-color:#e0e0e0;}
        .role-toggle-btn.selected-role{background-color:var(--primary-red);color:var(--pure-white);border:2px solid var(--accent-black);}
        .role-toggle-btn.selected-role:hover{background-color:#C62828;}
        #empPositionsContainer .pay-rate-input-wrapper { margin-top:0px;padding-left:0;width:100%;}
        #empPositionsContainer .pay-rate-input-wrapper label { font-size:0.8em;margin-bottom:2px;padding-left:2px;}
        #empPositionsContainer .pay-rate-input-wrapper input[type="number"] { padding:6px;font-size:0.9em;margin-bottom:3px;width:calc(100% - 16px);}
        
        #addEmployeeFormWrapper .button { margin-top:15px;padding:10px 15px;font-size:1.2em; }
        #addEmployeeFormWrapper #importSectionWrapper { margin-top:15px;padding-top:10px;border-top:2px dashed var(--border-color); }
        #addEmployeeFormWrapper #importSectionWrapper h4 { margin-bottom:8px;font-size:1.15em; }
        #addEmployeeFormWrapper #importSectionWrapper .button { font-size:0.9em!important;padding:6px 10px!important;margin-bottom:5px!important;margin-top:5px!important; }
        #addEmployeeFormWrapper #importSectionWrapper #importFileName { font-size:0.85em; }
        #addEmployeeFormWrapper #importSectionWrapper #importStatusMessages { font-size:0.8em;margin-top:3px; }
        #addEmployeeFormWrapper #importSectionWrapper #importStatusMessages ul { margin-top:3px;margin-bottom:0;padding-left:20px; }
        #addEmployeeFormWrapper #importSectionWrapper #importStatusMessages li { padding:2px 0;border:none;background:none;box-shadow:none;margin-bottom:0;color:var(--accent-black); }

        .day-nav-container { display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:15px;padding-bottom:15px;border-bottom:2px dashed var(--border-color); }
        .day-nav-container .day-nav-btn { font-family:var(--font-body);font-size:0.9em;padding:6px 12px;margin:0;min-width:80px;border-width:2px; }
        .day-nav-container .day-nav-btn.active-day { background-color:var(--accent-black);color:var(--pure-white);border-color:var(--accent-black); }

        .support-tip-detail { list-style-type:none;padding-left:20px;margin-top:5px;font-size:.9em }
        .support-tip-detail li { padding:4px 0;border-bottom:1px dotted #e0e0e0;color:#555 }
        .support-tip-detail li:last-child { border-bottom:none }
        .support-tip-detail strong { color:var(--accent-black) }

        /* --- TUTORIAL STYLES --- */
        .tutorial-btn {
            font-family: var(--font-body);
            font-size: 0.6em; /* Smaller font */
            padding: 4px 8px; /* Smaller padding */
            margin-left: auto; /* Pushes to the right */
            margin-top: 0;
            margin-right: 0;
            background-color: #42A5F5; /* A friendly blue */
            color: var(--pure-white);
            text-transform: none; /* Normal case */
            letter-spacing: normal;
            box-shadow: var(--box-shadow-light);
            border: 2px solid var(--accent-black);
        }
        .tutorial-btn:hover {
             background-color: #1E88E5;
        }

        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            display: none; /* Hidden by default */
        }
        #tutorial-highlight-box {
            position: fixed;
            z-index: 9999;
            border: 3px dashed var(--primary-red);
            background-color: rgba(229, 57, 53, 0.1);
            border-radius: var(--border-radius);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease-in-out;
            pointer-events: none; /* Allows clicking through */
        }
        #tutorial-text-box {
            position: fixed;
            z-index: 10000;
            background-color: var(--pure-white);
            color: var(--accent-black);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 3px solid var(--accent-black);
            box-shadow: var(--box-shadow-strong);
            max-width: 350px;
            font-size: 1em;
            line-height: 1.5;
            transition: top 0.3s ease-in-out, left 0.3s ease-in-out;
        }
        #tutorial-text-box h4 {
            font-family: var(--font-display);
            color: var(--primary-red);
            margin-top: 0;
            font-size: 1.5em;
        }
        .tutorial-nav {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tutorial-nav .button {
            font-size: 1em;
            padding: 8px 15px;
            margin: 0;
        }
        #tutorial-step-counter {
            font-size: 0.9em;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Diner Dash TipSplit Deluxe!</h1>
        </header>

        <div class="top-date-controls">
            <div class="date-control-group">
                <label for="cycleStartDateSelect">Cycle Start:</label>
                <select id="cycleStartDateSelect"></select>
            </div>
            <div class="date-control-group">
                <label for="weekInCycleSelect">Week in Cycle:</label>
                <select id="weekInCycleSelect">
                    <option value="1">Week 1</option>
                    <option value="2">Week 2</option>
                    <option value="3">Week 3</option>
                    <option value="4">Week 4</option>
                </select>
            </div>
        </div>
        <input type="date" id="currentDateHidden" style="display:none;">


        <div class="section-card" id="employeeFormSection" style="display: none;"> 
            <h2>
                Manage Jukebox Hero
                <button class="button tutorial-btn" data-tutorial-for="roster">How-To</button>
            </h2> 
            <div id="actualFormContainer"> 
                <button id="goBackToLineupBtn" class="button small-action-btn" style="margin-bottom: 15px;">&laquo; Back to The Lineup</button>
                <button id="toggleAddNewEmployeeFormBtn" class="button" style="margin-bottom: 15px;">Add New Jukebox Hero</button>
                
                <div id="addEmployeeFormWrapper" style="display: none;">
                    <div>
                        <label for="empName">Name:</label>
                        <input type="text" id="empName" placeholder="e.g., Fonzie">
                        <label>Rockin' Roles (Select all applicable):</label>
                        <div id="empPositionsContainer"></div>
                        <input type="hidden" id="editingEmployeeId">
                        <button id="addEmployeeBtn" class="button">Add to Crew</button>
                        <button id="updateEmployeeBtn" class="button" style="display:none;">Update Hero</button>
                        <button id="cancelEditBtn" class="button" style="background-color: #757575;">Nevermind</button>
                    </div>
                    <div id="importSectionWrapper" style="border-top: 2px dashed var(--border-color);">
                        <h4>Import Roster from .txt File</h4>
                        <label for="employeeImportFile" class="button" style="display: inline-block; margin-bottom: 10px; font-size: 1em; padding: 8px 12px;">Choose File...</label>
                        <input type="file" id="employeeImportFile" accept=".txt" style="display: none;"> 
                        <span id="importFileName" style="margin-left: 10px; font-style: italic; color: var(--accent-black);">No file chosen</span>
                        <div id="importStatusMessages" style="font-size: 0.9em; margin-top: 5px;"></div>
                    </div>
                </div>

                <div id="employeeListManagement">
                    <h3>All Jukebox Heroes:</h3>
                    <p style="font-size: 0.9em; margin-bottom: 15px;">Click 'Edit' to change their name or roles, or 'X' to remove them from the roster.</p>
                    <div id="fullEmployeeRosterContainer">
                        <p>Loading employee roster...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card" id="employeeLineupSection">
             <h2 class="collapsible-header" role="button" aria-expanded="true" aria-controls="lineupContent">
                The Lineup
                <button class="button tutorial-btn" data-tutorial-for="lineup">How-To</button>
                <span class="collapse-indicator">-</span>
             </h2>
            <div class="collapsible-content" id="lineupContent" style="display:block;">
                <div id="lineupDayNavContainer"></div> 
                <div class="date-display-wrapper">
                    <label style="display: inline-block; margin-right: 8px; font-size: 1.2em;">Selected Date:</label>
                    <span id="lineupDateDisplay" class="date-display">N/A</span>
                </div>
                <div id="rosterListContainer">
                    <p>Loading roster...</p>
                </div>
                <button id="showAddEmployeeFormBtn" class="button" style="margin-top: 15px;">Manage Roster / Add New Hero</button>
            </div>
        </div>
        
        <div class="section-card" id="payoutSection">
             <h2 class="collapsible-header" role="button" aria-expanded="false" aria-controls="payoutContent">
                The Daily Scoop 
                <button class="button tutorial-btn" data-tutorial-for="scoop">How-To</button>
                <span class="collapse-indicator">+</span>
             </h2>
            <div class="collapsible-content" id="payoutContent" style="display: none;">
                <div id="scoopDayNavContainer"></div>
                 <div class="date-display-wrapper">
                    <label style="display: inline-block; margin-right: 8px; font-size: 1.2em;">Selected Date:</label>
                    <span id="scoopDateDisplay" class="date-display">N/A</span>
                </div>
                <div id="payoutResults"></div>
            </div>
        </div>

        <div class="section-card" id="weeklyReportSection">
            <h2 class="collapsible-header" role="button" aria-expanded="false" aria-controls="weeklyReportContent">
                The Weekly Rewind
                <button class="button tutorial-btn" data-tutorial-for="weekly">How-To</button>
                <span class="collapse-indicator">+</span>
            </h2>
            <div class="collapsible-content" id="weeklyReportContent" style="display: none;">
                <div class="week-navigation">
                    <div class="week-navigation-buttons">
                        <button id="prevWeekBtn" class="button">&laquo; Prev Week</button>
                        <button id="nextWeekBtn" class="button">Next Week &raquo;</button>
                    </div>
                    <span id="currentlyViewedWeekDisplay">Week: N/A</span>
                </div>
                <button id="exportWeeklyCSVBtn" class="button" style="display:none;">Export This Week</button>
                <div id="reportOutput"></div>
            </div>
        </div>

        <!-- NEW: Settings and Data Management Section -->
        <div class="section-card" id="dataManagementSection">
            <h2 class="collapsible-header" role="button" aria-expanded="false" aria-controls="dataManagementContent">
                Settings &amp; Data Management
                <button class="button tutorial-btn" data-tutorial-for="data">How-To</button>
                <span class="collapse-indicator">+</span>
            </h2>
            <div class="collapsible-content" id="dataManagementContent" style="display: none;">
                <p>Here you can download all your data (roster and shifts) to a file for backup, or load a previously saved file to restore your state.</p>
                <div style="display:flex; flex-wrap:wrap; gap: 15px; margin-top:15px;">
                    <button id="downloadStateBtn" class="button">Download Save Data</button>
                    <label for="loadStateFile" class="button" style="background-color: #4CAF50;">Load Save Data</label>
                    <input type="file" id="loadStateFile" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- TUTORIAL OVERLAY HTML -->
    <div id="tutorial-overlay">
        <div id="tutorial-highlight-box"></div>
        <div id="tutorial-text-box">
            <h4 id="tutorial-title">Tutorial</h4>
            <p id="tutorial-text">Welcome to the tutorial!</p>
            <div class="tutorial-nav">
                <button id="tutorial-prev-btn" class="button small-action-btn">&laquo; Prev</button>
                <span id="tutorial-step-counter">1 / 5</span>
                <button id="tutorial-next-btn" class="button small-action-btn">Next &raquo;</button>
                <button id="tutorial-close-btn" class="button" style="background-color: #757575;">Close</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("APP_LOG: DOM Fully Loaded and Parsed");
    // --- Globals & State ---
    let employeeRoster = JSON.parse(localStorage.getItem('dinerTipSplit_employeeRosterV2')) || [];
    let dailyShifts = JSON.parse(localStorage.getItem('dinerTipSplit_dailyShiftsV2')) || {};
    const JOB_POSITIONS_AVAILABLE = ["Server", "Busser", "Shake Spinner", "Food Runner", "Host"];
    const BASE_CYCLE_START_DATE = new Date('2025-06-02T00:00:00Z'); 
    let currentReportWeekStartDate = null;
    let activeSelectedDate = null;
    let currentSelectedDayOfWeek = new Date().getUTCDay(); 

    // --- DOM Elements ---
    const currentDateHiddenInput = document.getElementById('currentDateHidden');
    const lineupDateDisplay = document.getElementById('lineupDateDisplay'); 
    const scoopDateDisplay = document.getElementById('scoopDateDisplay');
    const cycleStartDateSelect = document.getElementById('cycleStartDateSelect');
    const weekInCycleSelect = document.getElementById('weekInCycleSelect');
    const employeeFormSection = document.getElementById('employeeFormSection');
    const employeeLineupSection = document.getElementById('employeeLineupSection');
    const showAddEmployeeFormBtn = document.getElementById('showAddEmployeeFormBtn');
    const rosterListContainer = document.getElementById('rosterListContainer');
    const lineupDayNavContainer = document.getElementById('lineupDayNavContainer'); 
    const scoopDayNavContainer = document.getElementById('scoopDayNavContainer');
    const fullEmployeeRosterContainer = document.getElementById('fullEmployeeRosterContainer');
    const goBackToLineupBtn = document.getElementById('goBackToLineupBtn');
    const toggleAddNewEmployeeFormBtn = document.getElementById('toggleAddNewEmployeeFormBtn');
    const addEmployeeFormWrapper = document.getElementById('addEmployeeFormWrapper');
    const empNameInput = document.getElementById('empName');
    const empPositionsContainer = document.getElementById('empPositionsContainer');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const updateEmployeeBtn = document.getElementById('updateEmployeeBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editingEmployeeIdInput = document.getElementById('editingEmployeeId');
    const employeeImportFileInput = document.getElementById('employeeImportFile');
    const importFileNameDisplay = document.getElementById('importFileName');
    const importStatusMessagesDiv = document.getElementById('importStatusMessages');
    const payoutResultsDiv = document.getElementById('payoutResults');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const currentlyViewedWeekDisplay = document.getElementById('currentlyViewedWeekDisplay');
    const exportWeeklyCSVBtn = document.getElementById('exportWeeklyCSVBtn');
    const reportOutputDiv = document.getElementById('reportOutput');
    let currentWeeklyDataForExport = [];

    // Data Management DOM Elements
    const downloadStateBtn = document.getElementById('downloadStateBtn');
    const loadStateFileInput = document.getElementById('loadStateFile');

    // --- TUTORIAL ELEMENTS & STATE ---
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const tutorialHighlightBox = document.getElementById('tutorial-highlight-box');
    const tutorialTextBox = document.getElementById('tutorial-text-box');
    const tutorialTitle = document.getElementById('tutorial-title');
    const tutorialText = document.getElementById('tutorial-text');
    const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');
    const tutorialCloseBtn = document.getElementById('tutorial-close-btn');
    const tutorialStepCounter = document.getElementById('tutorial-step-counter');

    let currentTutorialSteps = [];
    let currentTutorialStepIndex = 0;
    let tutorialAnimationId = null;
    let currentTutorialTargetElement = null;

    const tutorials = {
        roster: [
            { element: '#toggleAddNewEmployeeFormBtn', title: 'Add a Hero', text: "Click here to open the form for adding a new employee to your crew." },
            { element: '#empName', title: 'Enter Name', text: "Enter the employee's full name here. This is how they'll appear in all reports." },
            { element: '#empPositionsContainer', title: 'Assign Roles', text: "Select one or more roles. An input for their hourly pay rate will appear for each role you select." },
            { element: '#addEmployeeBtn', title: 'Save New Hero', text: "Click here to save the new employee to the permanent roster." },
            { element: '#fullEmployeeRosterContainer', title: 'The Full Crew', text: "This list shows everyone currently on your roster. You can edit or remove them from here." },
            { element: '#fullEmployeeRosterContainer .edit-btn', fallbackElement: '#fullEmployeeRosterContainer', title: 'Edit a Hero', text: "Click 'Edit' to change an employee's name or update their roles and pay rates." },
            { element: '#fullEmployeeRosterContainer .remove-x-btn', fallbackElement: '#fullEmployeeRosterContainer', title: 'Remove a Hero', text: "Click the 'X' to permanently remove an employee and their shifts for the current day." },
            { element: '#importSectionWrapper', title: 'Import Roster', text: "You can also bulk-add employees by importing a specially formatted .txt file." },
            { element: '#goBackToLineupBtn', title: 'Back to Action', text: "When you're done managing the roster, click here to return to the daily shift logging view." },
        ],
        lineup: [
            { element: '.top-date-controls', title: 'Set the Date', text: "First, use these controls to select the correct payroll Cycle and Week you want to work on." },
            { element: '#lineupDayNavContainer', title: 'Select the Day', text: "Next, click a day of the week to view or log shifts for that specific date." },
            { element: '#rosterListContainer .employee-info strong', fallbackElement: '#rosterListContainer', title: 'Log a Shift', text: "Click an employee's name to open the form where you can log their shift details for the selected day." },
            { element: '.inline-shift-form-container', isDynamic: true, dynamicTrigger: '#rosterListContainer .employee-info strong', title: 'Enter Shift Details', text: "Enter the clock-in and clock-out times. For servers, also fill in their sales and tips." },
            { element: '.log-specific-shift-btn', isDynamic: true, dynamicTrigger: '#rosterListContainer .employee-info strong', title: 'Save the Shift', text: "Click here to save the shift. The employee's card will update with a summary, and the button will change to 'Edit Shift'." },
            { element: '#showAddEmployeeFormBtn', title: 'Manage Roster', text: "Need to add a new employee or edit an existing one? Click this button to jump to the Roster Management page." }
        ],
        scoop: [
            { element: '#scoopDayNavContainer', title: 'Select a Day', text: "Use these buttons to choose which day's results you want to see." },
            { element: '#payoutResults', title: 'Daily Payouts', text: "This table shows the calculated breakdown of wages, tips, and take-home pay for everyone who worked on the selected day." },
            { element: '.support-tip-detail', fallbackElement: '#payoutResults', title: 'Tip-In Details', text: "For support staff (like Bussers), you can see a detailed breakdown of which servers tipped them out and how much." },
            { element: '.remove-shift-from-scoop-btn', fallbackElement: '#payoutResults', title: 'Delete a Shift', text: "If a shift was logged by mistake, you can permanently remove it by clicking the 'Del' button in its row." }
        ],
        weekly: [
             { element: '.week-navigation', title: 'Navigate Weeks', text: "Use the 'Prev Week' and 'Next Week' buttons to browse through different weekly reports." },
             { element: '#reportOutput .data-table-container:first-of-type', fallbackElement: '#reportOutput', title: 'Weekly Totals', text: "This first table summarizes the total earnings (wages and tips) for each employee across the entire selected week." },
             { element: '#reportOutput .report-day-header', fallbackElement: '#reportOutput', title: 'Daily Breakdown', text: "Below the weekly summary, you'll find a detailed, day-by-day breakdown of all shifts that were logged." },
             { element: '.edit-shift-from-weekly-btn', fallbackElement: '#reportOutput', title: 'Quick Edit', text: "Made a mistake? Click 'Edit' on any shift in this report to instantly jump back to 'The Lineup' section with the correct form open, ready for you to make changes." },
             { element: '#exportWeeklyCSVBtn', title: 'Export to Excel', text: "Click here to download a beautifully formatted Excel file (.xlsx) of this week's report, complete with separate tabs for daily details and weekly totals." }
        ],
        data: [
            { element: '#downloadStateBtn', title: 'Backup Your Data', text: "Click this to save ALL your data—roster and every logged shift—to a single JSON file on your computer. It's a great idea to do this regularly as a backup!" },
            { element: '#loadStateFile', title: 'Restore Your Data', text: "If you need to restore your data from a backup, click here to select the `.json` file you previously saved. This will overwrite ALL current data in the app." }
        ]
    };


    // --- Utility Functions ---
    function triggerDailyScoopCalculation() {
        if (!activeSelectedDate) { 
            if(payoutResultsDiv) payoutResultsDiv.innerHTML = "<p>Please select a date first.</p>";
            return; 
        }
        const shiftsForSelectedDay = dailyShifts[activeSelectedDate];
        if (!shiftsForSelectedDay || shiftsForSelectedDay.length === 0) {
            if(payoutResultsDiv) payoutResultsDiv.innerHTML = `<p>No shifts have been logged for ${formatDisplayDate(activeSelectedDate)}.</p>`;
            return;
        }
        try {
            const processedShifts = runTipAndWageCalculationsForDay(shiftsForSelectedDay); 
            renderDailyPayoutResults(processedShifts);
        } catch (error) {
            console.error("Error during payout calculation:", error);
            if(payoutResultsDiv) payoutResultsDiv.innerHTML = "<p style='color:red;'>An error occurred during calculations.</p>";
        }
    }

    function triggerWeeklyRewindCalculation() {
         if (!currentReportWeekStartDate) {
            if(reportOutputDiv) reportOutputDiv.innerHTML = "<p>Week context not set. Navigate using main date controls or weekly navigation.</p>";
            return;
        }
        generateWeeklyReportContent();
    }


    const saveState = () => { 
        localStorage.setItem('dinerTipSplit_employeeRosterV2',JSON.stringify(employeeRoster)); 
        localStorage.setItem('dinerTipSplit_dailyShiftsV2',JSON.stringify(dailyShifts)); 
        console.log("APP_LOG: State saved."); 
        
        const payoutContent = document.getElementById('payoutContent');
        if (payoutContent && payoutContent.style.display !== 'none') {
            triggerDailyScoopCalculation();
        }
        const weeklyReportContent = document.getElementById('weeklyReportContent');
        if (weeklyReportContent && weeklyReportContent.style.display !== 'none') {
            triggerWeeklyRewindCalculation();
        }
    };
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;
    const formatDate = (dObj) => dObj.toISOString().split('T')[0];
    const formatDisplayDate = (dateStr) => { if(!dateStr)return "N/A"; const dObj=new Date(dateStr+'T00:00:00Z'); return dObj.toLocaleDateString('en-US',{weekday:'short',month:'2-digit',day:'2-digit',year:'numeric',timeZone:'UTC'});};
    function timeToMinutes(tStr){if(!tStr||!tStr.includes(':')) return 0;const[h,m]=tStr.split(':').map(Number);return h*60+m;}
    function calculateOverlapDurationMinutes(serverShift, supportShift) { const sStart = timeToMinutes(serverShift.timeIn); const sEnd = timeToMinutes(serverShift.timeOut); const supStart = timeToMinutes(supportShift.timeIn); const supEnd = timeToMinutes(supportShift.timeOut); return Math.max(0, Math.min(sEnd, supEnd) - Math.max(sStart, supStart)); }
    function calculateHoursWorked(tiStr,toStr){if(!tiStr||!toStr) return 0;const mi=timeToMinutes(tiStr),mo=timeToMinutes(toStr);if(mo<=mi) return 0;return(mo-mi)/60;}
    function roundToNearest15Minutes(tStr){if(!tStr||!tStr.includes(':')) return tStr;const[h,m]=tStr.split(':').map(Number);let tm=h*60+m;let rtm=Math.round(tm/15)*15;let rh=Math.floor(rtm/60);let rmin=rtm%60;if(rh>=24) rh=rh%24;return`${String(rh).padStart(2,'0')}:${String(rmin).padStart(2,'0')}`; }
    function formatTimeTo12Hour(timeString24) {if (!timeString24 || !timeString24.includes(':')) { return timeString24 || "N/A"; } let [hours, minutesStr] = timeString24.split(':'); let hoursNum = parseInt(hours, 10); const ampm = hoursNum >= 12 ? 'PM' : 'AM'; hoursNum = hoursNum % 12; hoursNum = hoursNum ? hoursNum : 12; const paddedHours = String(hoursNum).padStart(2, '0'); const paddedMinutes = String(minutesStr).padStart(2, '0'); return `${paddedHours}:${paddedMinutes} ${ampm}`; }
    function roundToNearestHalfDollar(amount) { return Math.round(amount * 2) / 2; }


    function getMondayOfWeek(dateObj) { const d=new Date(dateObj.getTime());d.setUTCHours(0,0,0,0);const day=d.getUTCDay();const diff=d.getUTCDate()-day+(day===0?-6:1);return new Date(d.setUTCDate(diff));}
    function getWeekInfo(dateString) { if (!dateString) { return { weekInCycle: "N/A", weekStartDate: null, weekEndDate: null }; } const selectedDate = new Date(dateString + 'T00:00:00Z'); if (isNaN(selectedDate.getTime())) { return { weekInCycle: "Invalid Date", weekStartDate: null, weekEndDate: null };} const weekStartDate = getMondayOfWeek(selectedDate); const weekEndDate = new Date(weekStartDate); weekEndDate.setUTCDate(weekStartDate.getUTCDate() + 6); const baseMonday = getMondayOfWeek(BASE_CYCLE_START_DATE); let weekInCycle = "N/A"; const diffTime = weekStartDate.getTime() - baseMonday.getTime(); if (diffTime >= 0) { const diffWeeks = Math.floor(diffTime / (1000*60*60*24*7)); weekInCycle = (diffWeeks % 4) + 1; } return { weekInCycle, weekStartDate: formatDate(weekStartDate), weekEndDate: formatDate(weekEndDate) }; }
    function findCycleAndWeekForDatePrecise(targetDate) {
        const baseMonday = getMondayOfWeek(BASE_CYCLE_START_DATE);
        const targetMonday = getMondayOfWeek(new Date(targetDate)); 

        const diffTimeMillis = targetMonday.getTime() - baseMonday.getTime();
        const diffDays = Math.round(diffTimeMillis / (1000 * 60 * 60 * 24)); 
        
        const diffCycles = Math.floor(diffDays / 28); 
        
        const cycleStartOffsetDays = diffCycles * 28;
        const cycleStartDate = new Date(baseMonday);
        cycleStartDate.setUTCDate(baseMonday.getUTCDate() + cycleStartOffsetDays);
        
        const daysIntoCurrentCycle = diffDays - cycleStartOffsetDays;
        const weekInCycle = Math.floor(daysIntoCurrentCycle / 7) + 1;

        return { cycleStart: formatDate(cycleStartDate), weekNum: weekInCycle };
    }

    function getSortableNameParts(name) {
        if (!name || typeof name !== 'string') return { lastName: '', firstName: '' };
        const parts = name.trim().split(/\s+/).filter(p => p); 
        if (parts.length === 0) return { lastName: '', firstName: '' };
        if (parts.length > 1) {
            const lastName = parts.pop(); 
            return { lastName: lastName, firstName: parts.join(' ') };
        }
        return { lastName: parts[0], firstName: '' }; 
    }

    function sortEmployeesByName(empA, empB_or_NameB, nameProperty = 'employeeName') {
        const nameA_Str = (typeof empA === 'string') ? empA : empA[nameProperty];
        const nameB_Str = (typeof empB_or_NameB === 'string') ? empB_or_NameB : empB_or_NameB[nameProperty];

        const nameA_Parts = getSortableNameParts(nameA_Str);
        const nameB_Parts = getSortableNameParts(nameB_Str);

        const lastNameComparison = nameA_Parts.lastName.toLowerCase().localeCompare(nameB_Parts.lastName.toLowerCase());
        if (lastNameComparison !== 0) {
            return lastNameComparison;
        }
        return nameA_Parts.firstName.toLowerCase().localeCompare(nameB_Parts.firstName.toLowerCase());
    }

    function initializeCollapsibleSections() { 
        console.log("APP_LOG: Initializing collapsible sections..."); 
        document.querySelectorAll('.collapsible-header').forEach(header => { 
            const contentId = header.getAttribute('aria-controls'); 
            const content = document.getElementById(contentId); 
            const indicator = header.querySelector('.collapse-indicator'); 
            if (!content) { console.warn(`Collapsible content NOT FOUND for ID: '${contentId}'`); return; } 
            
            // --- FIX: Add a collapse button at the bottom of the content ---
            if (!content.querySelector('.collapse-bottom-btn')) {
                const collapseBtnBottom = document.createElement('button');
                collapseBtnBottom.className = 'button collapse-bottom-btn';
                collapseBtnBottom.textContent = 'Collapse Section ↑';
                collapseBtnBottom.addEventListener('click', () => header.click());
                content.appendChild(collapseBtnBottom);
            }
            // --- End of FIX ---

            let startCollapsed = localStorage.getItem(`collapsible_${contentId}_collapsed`) !== 'false'; 
            if (contentId === 'lineupContent') { 
                startCollapsed = localStorage.getItem(`collapsible_${contentId}_collapsed`) === 'true';
            }

            content.style.display = startCollapsed ? 'none' : 'block'; 
            if(indicator) indicator.textContent = startCollapsed ? '+' : '-'; 
            header.setAttribute('aria-expanded', String(!startCollapsed)); 

            header.addEventListener('click', (e) => {
                // Prevent tutorial button from triggering collapse
                if (e.target.classList.contains('tutorial-btn')) return;

                const isCurrentlyHidden = content.style.display === 'none'; 
                content.style.display = isCurrentlyHidden ? 'block' : 'none'; 
                if(indicator) indicator.textContent = isCurrentlyHidden ? '-' : '+'; 
                header.setAttribute('aria-expanded', String(isCurrentlyHidden)); 
                localStorage.setItem(`collapsible_${contentId}_collapsed`, String(!isCurrentlyHidden)); 
                
                if (isCurrentlyHidden) { 
                    if (contentId === 'payoutContent') {
                        triggerDailyScoopCalculation();
                    } else if (contentId === 'weeklyReportContent') {
                        triggerWeeklyRewindCalculation();
                    } else if (contentId === 'lineupContent'){
                        applyMasonryLayoutToRoster(); 
                    }
                }
            }); 
            header.addEventListener('keydown', (event) => { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); header.click(); } }); 
            if (!header.hasAttribute('tabindex')) header.setAttribute('tabindex', '0'); 
        }); 
    }
    function populateCycleStartDateSelect() { console.log("APP_LOG:Populating Cycle Start Dates...");cycleStartDateSelect.innerHTML='';const today=new Date();today.setUTCHours(0,0,0,0);for(let i=-12;i<=12;i++){const cycleStart=new Date(BASE_CYCLE_START_DATE);cycleStart.setUTCDate(BASE_CYCLE_START_DATE.getUTCDate()+(i*28));const option=document.createElement('option');const dateValue=formatDate(cycleStart);option.value=dateValue;option.textContent=formatDisplayDate(dateValue);cycleStartDateSelect.appendChild(option);}let defaultCycleStartValue=formatDate(BASE_CYCLE_START_DATE);const todayUTCStart=new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate()));for(let i=0;i<cycleStartDateSelect.options.length;i++){const opt=cycleStartDateSelect.options[i];const optDate=new Date(opt.value+"T00:00:00Z");const cycleEndDate=new Date(optDate);cycleEndDate.setUTCDate(optDate.getUTCDate()+27);if(todayUTCStart>=optDate&&todayUTCStart<=cycleEndDate){defaultCycleStartValue=opt.value;break;}}if(cycleStartDateSelect.querySelector(`option[value="${defaultCycleStartValue}"]`)){cycleStartDateSelect.value=defaultCycleStartValue;}else if(cycleStartDateSelect.options.length>0){cycleStartDateSelect.selectedIndex=Math.floor(cycleStartDateSelect.options.length/2);}console.log("APP_LOG:Cycle Start Dates populated. Default:",cycleStartDateSelect.value);}
    
    function calculateAndUpdateCurrentDate(newDayOfWeekNum = null) { 
        const cycleStartStr = cycleStartDateSelect.value;
        const weekNum = parseInt(weekInCycleSelect.value);

        if (!cycleStartStr) {
            if (lineupDateDisplay) lineupDateDisplay.textContent = "Set Cycle Start"; 
            if (scoopDateDisplay) scoopDateDisplay.textContent = "Set Cycle Start";
            activeSelectedDate = null;
            renderLineupDayNavigation(); renderEmployeeRoster(); applyMasonryLayoutToRoster(); return;
        }
        const cycleStartDateObj = new Date(cycleStartStr + 'T00:00:00Z');
        
        const targetWeekMonday = new Date(cycleStartDateObj);
        targetWeekMonday.setUTCDate(cycleStartDateObj.getUTCDate() + (weekNum - 1) * 7);

        let targetDayOffset; 
        if (newDayOfWeekNum !== null) { 
            currentSelectedDayOfWeek = newDayOfWeekNum; 
            if (newDayOfWeekNum === 0) targetDayOffset = 6; 
            else targetDayOffset = newDayOfWeekNum - 1; 
        } else { 
            let dayToUse = currentSelectedDayOfWeek === undefined ? 1 : currentSelectedDayOfWeek; 
            if (dayToUse === 0) targetDayOffset = 6;
            else targetDayOffset = dayToUse - 1;
        }
        
        const targetDate = new Date(targetWeekMonday);
        targetDate.setUTCDate(targetWeekMonday.getUTCDate() + targetDayOffset);

        activeSelectedDate = formatDate(targetDate);
        if (currentDateHiddenInput) currentDateHiddenInput.value = activeSelectedDate;
        
        if (lineupDateDisplay) { 
            lineupDateDisplay.textContent = formatDisplayDate(activeSelectedDate); 
        }
        if (scoopDateDisplay) {
            scoopDateDisplay.textContent = formatDisplayDate(activeSelectedDate);
        }
        
        const currentWeekDateInfo = getWeekInfo(activeSelectedDate);
        if (currentWeekDateInfo.weekStartDate) {
            currentReportWeekStartDate = new Date(currentWeekDateInfo.weekStartDate + 'T00:00:00Z');
            updateCurrentlyViewedWeekDisplay(); 
        } else {
            currentReportWeekStartDate = null;
        }
        
        renderLineupDayNavigation();
        renderScoopDayNavigation();
        renderEmployeeRoster();        
        applyMasonryLayoutToRoster(); 

        const payoutContentEl = document.getElementById('payoutContent');
        if (payoutContentEl && payoutContentEl.style.display !== 'none') {
            triggerDailyScoopCalculation();
        }
        const weeklyReportContentEl = document.getElementById('weeklyReportContent');
        if (weeklyReportContentEl && weeklyReportContentEl.style.display !== 'none') {
           triggerWeeklyRewindCalculation(); 
        }
    }

    cycleStartDateSelect.addEventListener('change', () => calculateAndUpdateCurrentDate()); 
    weekInCycleSelect.addEventListener('change', () => calculateAndUpdateCurrentDate()); 
    
    function updateCurrentlyViewedWeekDisplay() { if(currentReportWeekStartDate){const endDate=new Date(currentReportWeekStartDate);endDate.setUTCDate(currentReportWeekStartDate.getUTCDate()+6);currentlyViewedWeekDisplay.textContent=`Viewing: ${formatDisplayDate(formatDate(currentReportWeekStartDate))} - ${formatDisplayDate(formatDate(endDate))}`; } else {currentlyViewedWeekDisplay.textContent="Week: N/A";}}

    function showEmployeeFormView(isEditing = false, empToEdit = null) { console.log("APP_LOG: Showing employee form section. Editing:", isEditing); employeeLineupSection.style.display = 'none'; employeeFormSection.style.display = 'block'; if (isEditing && empToEdit) { addEmployeeFormWrapper.style.display = 'block'; toggleAddNewEmployeeFormBtn.textContent = 'Hide Edit Form'; populateFormForEdit(empToEdit); } else { addEmployeeFormWrapper.style.display = 'none'; toggleAddNewEmployeeFormBtn.textContent = 'Add New Jukebox Hero'; resetFormForAdd(); } renderFullEmployeeListForManagement(); if (addEmployeeFormWrapper.style.display === 'block') { empNameInput.focus(); } }
    function showLineupView() { console.log("APP_LOG: Showing lineup view."); employeeFormSection.style.display = 'none'; employeeLineupSection.style.display = 'block'; const lineupContent = document.getElementById('lineupContent'); if (lineupContent && lineupContent.style.display === 'none') { const lineupHeader = lineupContent.previousElementSibling; if (lineupHeader && lineupHeader.classList.contains('collapsible-header')) { lineupHeader.click(); } else { lineupContent.style.display = 'block'; } } renderEmployeeRoster(); applyMasonryLayoutToRoster(); }
    showAddEmployeeFormBtn.addEventListener('click', () => showEmployeeFormView(false)); goBackToLineupBtn.addEventListener('click', showLineupView);
    toggleAddNewEmployeeFormBtn.addEventListener('click', () => { const isCurrentlyHidden = addEmployeeFormWrapper.style.display === 'none'; if (isCurrentlyHidden) { resetFormForAdd(); addEmployeeFormWrapper.style.display = 'block'; toggleAddNewEmployeeFormBtn.textContent = 'Hide Add Employee Form'; empNameInput.focus(); } else { addEmployeeFormWrapper.style.display = 'none'; toggleAddNewEmployeeFormBtn.textContent = 'Add New Jukebox Hero'; if (editingEmployeeIdInput.value) { resetFormForAdd(); } } });

    function renderEmpPositionsWithPayRates() { empPositionsContainer.innerHTML='';const editingEmpId=editingEmployeeIdInput.value;const empBeingEdited=editingEmpId?employeeRoster.find(e=>e.id===editingEmpId):null;if(JOB_POSITIONS_AVAILABLE.length===0){empPositionsContainer.innerHTML="<p>No job positions configured.</p>";return;}JOB_POSITIONS_AVAILABLE.forEach(pos=>{const posIdentifier=pos.replace(/\s+/g,'');const groupDiv=document.createElement('div');groupDiv.className='position-entry-group';const isSelected=empBeingEdited?empBeingEdited.positions.includes(pos):false;const currentPayRateValue=(empBeingEdited&&empBeingEdited.payRates&&empBeingEdited.payRates[pos]!==undefined)?String(empBeingEdited.payRates[pos]):'';const roleToggleButton=document.createElement('button');roleToggleButton.type='button';roleToggleButton.classList.add('button','role-toggle-btn');if(isSelected)roleToggleButton.classList.add('selected-role');else roleToggleButton.classList.add('is-not-working');roleToggleButton.dataset.position=pos;roleToggleButton.textContent=pos;roleToggleButton.setAttribute('aria-pressed',String(isSelected));const payRateWrapperDiv=document.createElement('div');payRateWrapperDiv.className='pay-rate-input-wrapper';payRateWrapperDiv.id=`payRateWrapper_${posIdentifier}`;payRateWrapperDiv.style.display=isSelected?'block':'none';const payRateLabel=document.createElement('label');payRateLabel.htmlFor=`payRate_${posIdentifier}`;payRateLabel.textContent=`${pos} Pay Rate ($/hr):`;const payRateInput=document.createElement('input');payRateInput.type='number';payRateInput.id=`payRate_${posIdentifier}`;payRateInput.dataset.position=pos;payRateInput.placeholder="0.00";payRateInput.step="0.01";payRateInput.value=currentPayRateValue;payRateWrapperDiv.appendChild(payRateLabel);payRateWrapperDiv.appendChild(payRateInput);groupDiv.appendChild(roleToggleButton);groupDiv.appendChild(payRateWrapperDiv);empPositionsContainer.appendChild(groupDiv);roleToggleButton.addEventListener('click',()=>{const currentlySelected=roleToggleButton.classList.toggle('selected-role');roleToggleButton.classList.toggle('is-not-working',!currentlySelected);roleToggleButton.setAttribute('aria-pressed',String(currentlySelected));payRateWrapperDiv.style.display=currentlySelected?'block':'none';if(!currentlySelected){payRateInput.value='';}else{payRateInput.focus();}});});}
    function populateFormForEdit(emp) { console.log("APP_LOG: Populating form for edit:", emp.name); editingEmployeeIdInput.value = emp.id; empNameInput.value = emp.name; renderEmpPositionsWithPayRates(); addEmployeeBtn.style.display = 'none'; updateEmployeeBtn.style.display = 'inline-block'; cancelEditBtn.style.display = 'inline-block'; }
    function resetFormForAdd() {  console.log("APP_LOG: Resetting form for add."); empNameInput.value = ''; editingEmployeeIdInput.value = ''; renderEmpPositionsWithPayRates(); addEmployeeBtn.style.display = 'inline-block'; updateEmployeeBtn.style.display = 'none'; cancelEditBtn.style.display = 'inline-block'; }

    addEmployeeBtn.addEventListener('click', () => { console.log("APP_LOG:Add Employee Clicked"); const name=empNameInput.value.trim();if(!name){alert("Name!");return;} const selectedPositions=[];const payRates={}; const positionEntryGroups=empPositionsContainer.querySelectorAll('.position-entry-group'); if(positionEntryGroups.length===0&&JOB_POSITIONS_AVAILABLE.length>0){alert("Error: Positions form not loaded.");return;} positionEntryGroups.forEach(group=>{ const roleBtn=group.querySelector('button.role-toggle-btn'); if(roleBtn&&roleBtn.classList.contains('selected-role')){ const position=roleBtn.dataset.position;selectedPositions.push(position); const payRateInput=group.querySelector(`.pay-rate-input-wrapper input[data-position="${position}"]`); if(payRateInput){payRates[position]=parseFloat(payRateInput.value)||0;}else{payRates[position]=0;} } }); if(selectedPositions.length===0&&JOB_POSITIONS_AVAILABLE.length>0){alert("Pick a role!");return;} employeeRoster.push({id:generateId(),name,positions:selectedPositions,payRates:payRates}); saveState(); renderFullEmployeeListForManagement(); addEmployeeFormWrapper.style.display = 'none'; toggleAddNewEmployeeFormBtn.textContent = 'Add New Jukebox Hero'; resetFormForAdd(); });
    updateEmployeeBtn.addEventListener('click', () => { const empId=editingEmployeeIdInput.value;const name=empNameInput.value.trim();if(!name){alert("Name!");return;} const selectedPositions=[];const payRates={}; empPositionsContainer.querySelectorAll('.position-entry-group').forEach(group=>{ const roleBtn=group.querySelector('button.role-toggle-btn'); if(roleBtn&&roleBtn.classList.contains('selected-role')){ const position=roleBtn.dataset.position;selectedPositions.push(position); const payRateInput=group.querySelector(`.pay-rate-input-wrapper input[data-position="${position}"]`); if(payRateInput){payRates[position]=parseFloat(payRateInput.value)||0;}else{payRates[position]=0;} } }); if(selectedPositions.length===0&&JOB_POSITIONS_AVAILABLE.length>0){alert("Role!");return;} const empIndex=employeeRoster.findIndex(e=>e.id===empId); if(empIndex>-1){employeeRoster[empIndex]={...employeeRoster[empIndex],name,positions:selectedPositions,payRates:payRates};} saveState(); renderFullEmployeeListForManagement(); addEmployeeFormWrapper.style.display = 'none'; toggleAddNewEmployeeFormBtn.textContent = 'Add New Jukebox Hero'; resetFormForAdd(); });
    cancelEditBtn.addEventListener('click', () => { resetFormForAdd(); addEmployeeFormWrapper.style.display = 'none'; toggleAddNewEmployeeFormBtn.textContent = 'Add New Jukebox Hero'; });
    function handleRemoveEmployee(event) { const empId=event.target.dataset.id; if(confirm("Boot this hero? This will also remove any of their logged shifts for the currently selected day.")){ employeeRoster=employeeRoster.filter(e=>e.id!==empId); if (activeSelectedDate && dailyShifts[activeSelectedDate]) { dailyShifts[activeSelectedDate] = dailyShifts[activeSelectedDate].filter(s => s.employeeId !== empId); if (dailyShifts[activeSelectedDate].length === 0) { delete dailyShifts[activeSelectedDate]; } } saveState(); renderEmployeeRoster(); renderFullEmployeeListForManagement(); } }

    function updateEmployeeLineupCard(liElement, buttonElement, shiftData) {
        if (!liElement || !buttonElement) { return; }
        const employeeId = buttonElement.dataset.empid;
        const positionContext = buttonElement.dataset.positioncontext;
        const employeeInfoDiv = liElement.querySelector('.employee-info');

        let shiftSummaryDiv = liElement.querySelector('.shift-summary-display');
        if (shiftSummaryDiv) shiftSummaryDiv.remove();

        buttonElement.classList.remove('is-not-working', 'is-working', 'is-editing-shift');
        delete buttonElement.dataset.shiftId; 

        if (shiftData && typeof shiftData.id === 'string' && shiftData.id.trim() !== '') {
            buttonElement.textContent = `Edit Shift (${formatTimeTo12Hour(shiftData.timeIn)})`;
            buttonElement.dataset.action = "edit";
            buttonElement.dataset.shiftId = shiftData.id; 
            buttonElement.classList.add('is-editing-shift');
            buttonElement.setAttribute('aria-pressed', 'true');

            if (employeeInfoDiv) {
                shiftSummaryDiv = document.createElement('div');
                shiftSummaryDiv.className = 'shift-summary-display';
                let summaryText = `${formatTimeTo12Hour(shiftData.timeIn)} - ${formatTimeTo12Hour(shiftData.timeOut)} (${calculateHoursWorked(shiftData.timeIn, shiftData.timeOut).toFixed(2)} hrs)`; 
                if (shiftData.positionWorked === "Server") {
                    summaryText += ` | Sales: $${(shiftData.totalSales || 0).toFixed(2)}`;
                    summaryText += ` | Tips: $${((shiftData.ccTips || 0) + (shiftData.cashTips || 0)).toFixed(2)}`;
                }
                shiftSummaryDiv.textContent = summaryText;
                employeeInfoDiv.appendChild(shiftSummaryDiv);
            }
        } else {
            buttonElement.textContent = "Log Shift";
            buttonElement.dataset.action = "mark";
            buttonElement.classList.add('is-not-working');
            buttonElement.setAttribute('aria-pressed', 'false');
        }
    }

    function renderDayNavigation(container, dateForNav) {
        if (!container || !dateForNav) { if(container) container.innerHTML=''; return; }
        container.innerHTML = '';
        const navDiv = document.createElement('div');
        navDiv.className = 'day-nav-container'; // Use a generic class if style is shared

        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dayValues = [1, 2, 3, 4, 5, 6, 0];
        const activeDayNum = new Date(dateForNav + 'T00:00:00Z').getUTCDay();

        dayValues.forEach((dayVal, index) => {
            const btn = document.createElement('button');
            btn.classList.add('button', 'small-action-btn', 'day-nav-btn');
            btn.textContent = days[index];
            btn.dataset.dayValue = dayVal;

            if (dayVal === activeDayNum) {
                btn.classList.add('active-day');
            }

            btn.addEventListener('click', (e) => {
                const selectedDay = parseInt(e.target.dataset.dayValue);
                calculateAndUpdateCurrentDate(selectedDay);
            });
            navDiv.appendChild(btn);
        });
        container.appendChild(navDiv);
    }
    
    function renderLineupDayNavigation() { renderDayNavigation(lineupDayNavContainer, activeSelectedDate); }
    function renderScoopDayNavigation() { renderDayNavigation(scoopDayNavContainer, activeSelectedDate); }


    function renderEmployeeRoster() {
        console.log("APP_LOG:Rendering Employee Roster (The Lineup) for date:", activeSelectedDate);
        if (!rosterListContainer) { console.error("APP_LOG: Roster list container (#rosterListContainer) not found!"); return; }
        rosterListContainer.innerHTML = ''; 
        
        const positionDisplayOrder = ["Server", "Busser", "Food Runner", "Shake Spinner", "Host", ...JOB_POSITIONS_AVAILABLE.filter(p => !["Server", "Busser", "Food Runner", "Shake Spinner", "Host"].includes(p))];

        positionDisplayOrder.forEach(posKey => {
            const employeesInThisPosition = employeeRoster.filter(emp => emp.positions.includes(posKey));
            if (employeesInThisPosition.length > 0) {
                const positionGroupDiv = document.createElement('div'); 
                positionGroupDiv.className = 'roster-position-group';
                
                const groupHeader = document.createElement('h5'); 
                groupHeader.className = 'position-group-header-roster'; 
                groupHeader.textContent = posKey + 's';
                positionGroupDiv.appendChild(groupHeader);
                
                const ul = document.createElement('ul'); 
                ul.className = 'item-list roster-lineup-selectable';

                employeesInThisPosition.sort((a,b) => sortEmployeesByName(a,b,'name')).forEach(emp => { 
                    const li = document.createElement('li');
                    li.id = `roster-emp-${emp.id}-${posKey.replace(/\s+/g, '')}`;

                    const mainInfoDiv = document.createElement('div'); mainInfoDiv.className = 'roster-item-main-info';
                    const empInfoDiv = document.createElement('div'); empInfoDiv.className = 'employee-info';
                    const nameStrong = document.createElement('strong');
                    nameStrong.dataset.empid = emp.id; nameStrong.dataset.positioncontext = posKey;
                    nameStrong.title = `Click to log/edit shift for ${emp.name} as ${posKey}`; nameStrong.textContent = emp.name;
                    empInfoDiv.appendChild(nameStrong); mainInfoDiv.appendChild(empInfoDiv);

                    const actionsDiv = document.createElement('div'); actionsDiv.className = 'employee-actions';
                    const toggleWorkedBtn = document.createElement('button');
                    toggleWorkedBtn.classList.add('button', 'worked-today-toggle-btn');
                    toggleWorkedBtn.dataset.empid = emp.id; toggleWorkedBtn.dataset.positioncontext = posKey;
                    
                    toggleWorkedBtn.addEventListener('click', (e) => {
                        const btn = e.target; 
                        const empId = btn.dataset.empid;
                        const localPositionContext = btn.dataset.positioncontext;
                        const currentAction = btn.dataset.action;
                        const formContainer = document.getElementById(`inline-form-${empId}-${localPositionContext.replace(/\s+/g, '')}`);
                        const employeeData = employeeRoster.find(eRemp => eRemp.id === empId);

                        if (!employeeData || !formContainer) { console.error("TOGGLE_BTN_CLICK_ERR: Missing data.", {empId, localPositionContext, employeeData, formContainer}); return; }
                        
                        if (currentAction === "edit") {
                            renderInlineShiftForm(formContainer, employeeData, localPositionContext);
                            handleEditLoggedShiftSetup({ target: btn }); 
                            formContainer.style.display = 'block';
                        } else { 
                            const isOpeningForm = formContainer.style.display === 'none';
                            if (isOpeningForm) {
                                renderInlineShiftForm(formContainer, employeeData, localPositionContext);
                                formContainer.style.display = 'block';
                                btn.textContent = 'Close Shift Form';
                                btn.classList.remove('is-not-working', 'is-editing-shift');
                                btn.classList.add('is-working');
                                btn.setAttribute('aria-pressed', 'true');
                                const firstInput = formContainer.querySelector('input[type="time"], select');
                                if(firstInput) firstInput.focus();
                            } else { 
                                formContainer.innerHTML = '';
                                formContainer.style.display = 'none';
                                const existingShiftForCancel = dailyShifts[activeSelectedDate]?.find(s => s.employeeId === empId && s.positionWorked === localPositionContext);
                                updateEmployeeLineupCard(li, btn, existingShiftForCancel); 
                            }
                        }
                        applyMasonryLayoutToRoster(); 
                    });
                    nameStrong.addEventListener('click', () => toggleWorkedBtn.click() );
                    actionsDiv.appendChild(toggleWorkedBtn); mainInfoDiv.appendChild(actionsDiv); li.appendChild(mainInfoDiv);

                    const inlineFormDiv = document.createElement('div');
                    inlineFormDiv.id = `inline-form-${emp.id}-${posKey.replace(/\s+/g, '')}`;
                    inlineFormDiv.className = 'inline-shift-form-container';
                    inlineFormDiv.style.display = 'none';
                    li.appendChild(inlineFormDiv);
                    ul.appendChild(li);

                    let existingShift = null;
                    if (activeSelectedDate && dailyShifts[activeSelectedDate]) {
                        existingShift = dailyShifts[activeSelectedDate].find(s => s.employeeId === emp.id && s.positionWorked === posKey);
                    }
                    updateEmployeeLineupCard(li, toggleWorkedBtn, existingShift);
                });
                positionGroupDiv.appendChild(ul); 
                rosterListContainer.appendChild(positionGroupDiv);
            }
        });
        applyMasonryLayoutToRoster(); 
    }
    
    function applyMasonryLayoutToRoster() {
        if (!rosterListContainer || window.innerWidth <= 768) { 
            if (rosterListContainer) {
                 rosterListContainer.querySelectorAll('.roster-position-group').forEach(item => {
                    item.style.gridRowEnd = '';
                });
                rosterListContainer.style.display = (window.innerWidth <= 768) ? 'block' : 'grid'; 
            }
            return;
        }
        
        const items = rosterListContainer.querySelectorAll('.roster-position-group');
        if (!items.length) return;

        rosterListContainer.style.display = 'grid'; 
        const gridRowGap = parseInt(window.getComputedStyle(rosterListContainer).getPropertyValue('grid-row-gap')) || 20;
        const gridAutoRows = 10; 

        items.forEach(item => {
            item.style.gridRowEnd = ""; 
            const contentHeight = item.scrollHeight; 
            const rowSpan = Math.ceil((contentHeight + gridRowGap) / (gridAutoRows + gridRowGap));
            item.style.gridRowEnd = `span ${rowSpan}`;
        });
    }

    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(applyMasonryLayoutToRoster, 200); 
    });


    function renderFullEmployeeListForManagement() { console.log("APP_LOG: Rendering full employee list for management."); fullEmployeeRosterContainer.innerHTML = ''; if (employeeRoster.length === 0) { fullEmployeeRosterContainer.innerHTML = '<p>No employees in the roster yet. Add a new hero above!</p>'; return; } const ul = document.createElement('ul'); ul.className = 'item-list'; employeeRoster.sort((a,b) => sortEmployeesByName(a,b,'name')).forEach(emp => { const li = document.createElement('li'); li.id = `management-emp-${emp.id}`; const employeeInfoDiv = document.createElement('div'); employeeInfoDiv.className = 'employee-info'; employeeInfoDiv.innerHTML = `<strong>${emp.name}</strong><span class="roster-positions">${emp.positions.join(', ')}</span>`; const actionsDiv = document.createElement('div'); actionsDiv.className = 'employee-actions'; const editBtn = document.createElement('button'); editBtn.className = 'button small-action-btn edit-btn'; editBtn.dataset.id = emp.id; editBtn.textContent = 'Edit'; editBtn.addEventListener('click', () => { showEmployeeFormView(true, emp); }); actionsDiv.appendChild(editBtn); const removeXBtn = document.createElement('button'); removeXBtn.className = 'remove-x-btn'; removeXBtn.dataset.id = emp.id; removeXBtn.textContent = 'X'; removeXBtn.setAttribute('aria-label', `Remove ${emp.name}`); removeXBtn.addEventListener('click', handleRemoveEmployee); li.append(employeeInfoDiv, actionsDiv, removeXBtn); ul.appendChild(li); }); fullEmployeeRosterContainer.appendChild(ul); }

    function renderInlineShiftForm(containerElement, employee, positionWorkedContext) { 
        containerElement.innerHTML = ''; 
        const formDiv = document.createElement('div'); 
        formDiv.dataset.shiftFormFor = employee.id; formDiv.dataset.shiftPosition = positionWorkedContext;
        const posDisplay = document.createElement('p'); posDisplay.innerHTML = `Logging shift as: <strong>${positionWorkedContext}</strong> for ${employee.name}`;
        formDiv.appendChild(posDisplay);
        
        const timeInputsGroup = document.createElement('div'); timeInputsGroup.className = 'time-inputs-group';
        const timeInContainer = document.createElement('div'); 
        const timeInLabel = document.createElement('label'); timeInLabel.textContent = 'Clock In:'; 
        const timeInInline = document.createElement('input'); timeInInline.type = 'time'; timeInInline.step = '60'; 
        timeInInline.className = 'inline-shift-timein'; 
        timeInContainer.append(timeInLabel, timeInInline); timeInputsGroup.appendChild(timeInContainer);
        
        const timeOutContainer = document.createElement('div'); 
        const timeOutLabel = document.createElement('label'); timeOutLabel.textContent = 'Clock Out:'; 
        const timeOutInline = document.createElement('input'); timeOutInline.type = 'time'; timeOutInline.step = '60'; 
        timeOutInline.className = 'inline-shift-timeout'; 
        timeOutContainer.append(timeOutLabel, timeOutInline); timeInputsGroup.appendChild(timeOutContainer);
        formDiv.appendChild(timeInputsGroup);

        const serverTipsDiv = document.createElement('div'); serverTipsDiv.className = 'inline-server-tips'; 
        serverTipsDiv.style.display = (positionWorkedContext === "Server") ? 'block' : 'none';
        
        const tipInputsGroup = document.createElement('div'); tipInputsGroup.className = 'tip-inputs-group';
        
        const salesContainer = document.createElement('div');
        const salesLabel = document.createElement('label'); salesLabel.textContent = 'Total Sales ($):';
        const salesInput = document.createElement('input'); salesInput.type = 'number'; salesInput.placeholder = '0.00'; salesInput.step = '0.01'; salesInput.className = 'inline-shift-sales';
        salesContainer.append(salesLabel, salesInput);
        tipInputsGroup.appendChild(salesContainer);

        const ccTipContainer = document.createElement('div'); const ccLabel = document.createElement('label'); ccLabel.textContent = 'CC Tips ($):'; const ccInput = document.createElement('input'); ccInput.type = 'number'; ccInput.placeholder = '0.00'; ccInput.step = '0.01'; ccInput.className = 'inline-shift-cctips'; ccTipContainer.append(ccLabel, ccInput); tipInputsGroup.appendChild(ccTipContainer);
        const cashTipContainer = document.createElement('div'); const cashLabel = document.createElement('label'); cashLabel.textContent = 'Cash Tips ($):'; const cashInput = document.createElement('input'); cashInput.type = 'number'; cashInput.placeholder = '0.00'; cashInput.step = '0.01'; cashInput.className = 'inline-shift-cashtips'; cashTipContainer.append(cashLabel, cashInput); tipInputsGroup.appendChild(cashTipContainer);
        serverTipsDiv.appendChild(tipInputsGroup); formDiv.appendChild(serverTipsDiv);

        const formActionsDiv = document.createElement('div'); formActionsDiv.className = 'inline-form-actions';
        const logShiftInlineBtn = document.createElement('button');
        logShiftInlineBtn.textContent = `Log Shift`; 
        logShiftInlineBtn.classList.add('button', 'small-action-btn', 'log-specific-shift-btn');
        logShiftInlineBtn.dataset.employeeId = employee.id; 
        logShiftInlineBtn.addEventListener('click', () => {
            const date = activeSelectedDate; const timeIn = timeInInline.value; const timeOut = timeOutInline.value;
            const shiftIdToEdit = logShiftInlineBtn.dataset.editingShiftId; 
            if (!date || !employee.id || !positionWorkedContext || !timeIn || !timeOut) { alert("All fields in shift form required!"); return; }
            if (timeToMinutes(timeOut) <= timeToMinutes(timeIn)) { alert("Clock Out must be after Clock In!"); return; }
            const shiftPayRate = (employee.payRates && employee.payRates[positionWorkedContext] !== undefined) ? parseFloat(employee.payRates[positionWorkedContext]) : 0;
            let currentShiftData = { date, employeeId: employee.id, employeeName: employee.name, positionWorked: positionWorkedContext, shiftPayRate, timeIn, timeOut }; 
            
            if (positionWorkedContext === "Server") { 
                currentShiftData.ccTips = parseFloat(ccInput.value) || 0; 
                currentShiftData.cashTips = parseFloat(cashInput.value) || 0; 
                currentShiftData.totalSales = parseFloat(salesInput.value) || 0; 
                if (isNaN(currentShiftData.totalSales) || currentShiftData.totalSales < 0) {
                    alert("Please enter a valid positive number for Total Sales.");
                    return;
                }
            }
            
            if (shiftIdToEdit) { 
                const shiftIndex = dailyShifts[date]?.findIndex(s => s.id === shiftIdToEdit);
                if (shiftIndex > -1 && dailyShifts[date]) { 
                    dailyShifts[date][shiftIndex] = { ...dailyShifts[date][shiftIndex], ...currentShiftData }; 
                    currentShiftData = dailyShifts[date][shiftIndex]; 
                    alert(`Shift updated!`); 
                } else { console.error("Error finding shift to update. ID:", shiftIdToEdit, "Available shifts:", dailyShifts[date]); alert("Error: Original shift to update not found."); return; }
            } else { 
                currentShiftData.id = generateId(); 
                if (!dailyShifts[date]) dailyShifts[date] = []; 
                dailyShifts[date].push(currentShiftData); alert(`Shift logged!`);
            }
            saveState(); 
            if(containerElement) { containerElement.style.display = 'none'; containerElement.innerHTML = ''; } 
            const liElement = document.getElementById(`roster-emp-${employee.id}-${positionWorkedContext.replace(/\s+/g, '')}`);
            const buttonElement = liElement ? liElement.querySelector('.worked-today-toggle-btn') : null;
            if (liElement && buttonElement) {
                updateEmployeeLineupCard(liElement, buttonElement, currentShiftData);
            } else {
                renderEmployeeRoster(); 
            }
             applyMasonryLayoutToRoster(); 
        });
        formActionsDiv.appendChild(logShiftInlineBtn); 
        formDiv.appendChild(formActionsDiv); 
        containerElement.appendChild(formDiv); 
    }
    
    employeeImportFileInput.addEventListener('change', handleFileImport);
    function handleFileImport(event) { const file=event.target.files[0];if(!file){importFileNameDisplay.textContent="No file.";importStatusMessagesDiv.innerHTML="";return;}if(file.type!=="text/plain"){alert("TXT files only!");importFileNameDisplay.textContent="Invalid type.";importStatusMessagesDiv.innerHTML="<p style='color:red;'>Need .txt</p>";employeeImportFileInput.value='';return;}importFileNameDisplay.textContent=`Selected: ${file.name}`;importStatusMessagesDiv.innerHTML="<p>Processing...</p>";const reader=new FileReader();reader.onload=(e)=>{processImportedEmployeeData(e.target.result);};reader.onerror=()=>{alert("Error reading file.");importStatusMessagesDiv.innerHTML="<p style='color:red;'>Error reading.</p>";employeeImportFileInput.value='';};reader.readAsText(file);}
    function processImportedEmployeeData(content) { const lines=content.split(/\r?\n/);let importedCount=0;let skippedEntries=0;let errorMessages=[];for(let i=0;i<lines.length;i+=3){if(i+2>=lines.length){if(lines.slice(i).filter(l=>l.trim()!=="").length>0){errorMessages.push(`Skipping incomplete entry at end (lines ${i+1}-${lines.length}).`);skippedEntries++;}break;}const name=lines[i].trim();const posLine=lines[i+1].trim();const rateLine=lines[i+2].trim();if(!name){errorMessages.push(`Skipping line ${i+1}: Name missing.`);skippedEntries++;continue;}if(!posLine){errorMessages.push(`Skipping "${name}" (line ${i+1}): Positions missing.`);skippedEntries++;continue;}if(!rateLine){errorMessages.push(`Skipping "${name}" (line ${i+1}): Rates missing.`);skippedEntries++;continue;}const impPosRaw=posLine.split(',').map(p=>p.trim()).filter(p=>p);const impRateRaw=rateLine.split(',').map(r=>r.trim()).filter(r=>r);if(impPosRaw.length!==impRateRaw.length){errorMessages.push(`Skipping "${name}": Mismatch ${impPosRaw.length} positions, ${impRateRaw.length} rates.`);skippedEntries++;continue;}if(impPosRaw.length===0){errorMessages.push(`Skipping "${name}": No positions.`);skippedEntries++;continue;}const validPosEmp=[];const empPayRates={};let entryIssues=false;for(let j=0;j<impPosRaw.length;j++){const pos=impPosRaw[j];const rStr=impRateRaw[j];const rate=parseFloat(rStr);if(JOB_POSITIONS_AVAILABLE.includes(pos)){if(!isNaN(rate)&&rate>=0){validPosEmp.push(pos);empPayRates[pos]=rate;}else{errorMessages.push(`For "${name}", invalid rate "${rStr}" for "${pos}". Skipped.`);entryIssues=true;}}else{errorMessages.push(`For "${name}", unknown position "${pos}". Skipped.`);entryIssues=true;}}if(validPosEmp.length===0){if(!entryIssues){errorMessages.push(`Skipping "${name}": No valid positions after filter.`);}skippedEntries++;continue;}const exEmpIdx=employeeRoster.findIndex(e=>e.name.toLowerCase()===name.toLowerCase());if(exEmpIdx>-1){employeeRoster[exEmpIdx].positions=validPosEmp;employeeRoster[exEmpIdx].payRates=empPayRates;errorMessages.push(`Updated: "${name}".`);}else{employeeRoster.push({id:generateId(),name,positions:validPosEmp,payRates:empPayRates});}importedCount++;}saveState(); renderEmployeeRoster();renderFullEmployeeListForManagement();let statHTML=`<p style="color:green;">Processed ${importedCount} entries.</p>`;if(skippedEntries>0){statHTML+=`<p style="color:orange;">Skipped ${skippedEntries} entries.</p>`;}if(errorMessages.length>0){statHTML+='<strong>Details:</strong><ul>';errorMessages.forEach(m=>statHTML+=`<li>${m}</li>`);statHTML+='</ul>';}importStatusMessagesDiv.innerHTML=statHTML;employeeImportFileInput.value='';}

    function handleEditLoggedShiftSetup(event) {
        const buttonClicked = event.target; 
        const shiftId = buttonClicked.dataset.shiftId; 
        const shiftDate = activeSelectedDate; 

        if (!shiftId || typeof shiftId !== 'string' || shiftId.trim() === '') { 
            const problemLi = buttonClicked.closest('li');
            if (problemLi) updateEmployeeLineupCard(problemLi, buttonClicked, null);
            return; 
        }
        if (!dailyShifts[shiftDate]) { 
            const problemLi = buttonClicked.closest('li');
            if (problemLi) updateEmployeeLineupCard(problemLi, buttonClicked, null);
            return; 
        }
        
        const shiftToEdit = dailyShifts[shiftDate].find(s => s.id === shiftId);
        if (!shiftToEdit) { 
            const problemLi = buttonClicked.closest('li');
            if (problemLi) updateEmployeeLineupCard(problemLi, buttonClicked, null);
            return; 
        }
        
        const employee = employeeRoster.find(e => e.id === shiftToEdit.employeeId);
        if (!employee) { alert("Error: Employee data not found for this shift."); return; }

        const positionContext = shiftToEdit.positionWorked;
        const rosterLi = buttonClicked.closest('li'); 
        if (!rosterLi) { alert("Error displaying edit form (parent LI not found)."); return; }
        
        let inlineFormContainer = rosterLi.querySelector('.inline-shift-form-container');
        if (!inlineFormContainer) { return; }
        
        renderInlineShiftForm(inlineFormContainer, employee, positionContext); 
        inlineFormContainer.style.display = 'block';

        setTimeout(() => {
            const formDiv = inlineFormContainer.firstChild; 
            if (!formDiv) { return; }

            const timeInInline = formDiv.querySelector('.inline-shift-timein');
            const timeOutInline = formDiv.querySelector('.inline-shift-timeout');
            const ccInput = formDiv.querySelector('.inline-shift-cctips');
            const cashInput = formDiv.querySelector('.inline-shift-cashtips');
            const salesInput = formDiv.querySelector('.inline-shift-sales');
            const logBtn = formDiv.querySelector('.log-specific-shift-btn'); 
            const formActionsDiv = formDiv.querySelector('.inline-form-actions');

            if (timeInInline) timeInInline.value = shiftToEdit.timeIn; 
            if (timeOutInline) timeOutInline.value = shiftToEdit.timeOut; 
            
            const serverTipsDiv = formDiv.querySelector('.inline-server-tips');
            if (shiftToEdit.positionWorked === "Server" && serverTipsDiv) {
                if (ccInput) ccInput.value = shiftToEdit.ccTips || '';
                if (cashInput) cashInput.value = shiftToEdit.cashTips || '';
                if (salesInput) salesInput.value = shiftToEdit.totalSales || '';
                serverTipsDiv.style.display = 'block';
            } else if (serverTipsDiv) {
                serverTipsDiv.style.display = 'none';
            }

            if (logBtn) {
                logBtn.textContent = `Update Shift`;
                logBtn.dataset.editingShiftId = shiftId; 
            }

            if (formActionsDiv) {
                formActionsDiv.querySelectorAll('.delete-shift-btn, .cancel-edit-inline-btn').forEach(btn => btn.remove());

                const deleteShiftBtn = document.createElement('button');
                deleteShiftBtn.textContent = 'Delete Shift';
                deleteShiftBtn.classList.add('button', 'small-action-btn', 'delete-shift-btn');
                deleteShiftBtn.style.backgroundColor = '#AA0000'; deleteShiftBtn.style.borderColor = 'var(--accent-black)';
                deleteShiftBtn.addEventListener('click', () => {
                    if (confirm("Really delete this shift? This cannot be undone.")) {
                        handleRemoveLoggedShift({ target: { dataset: { 
                            shiftid: shiftId, 
                            date: shiftDate, 
                            empid: employee.id, 
                            positioncontext: positionContext 
                        }}});
                        inlineFormContainer.style.display = 'none'; 
                        inlineFormContainer.innerHTML = ''; 
                    }
                });
                formActionsDiv.appendChild(deleteShiftBtn);

                const cancelEditInlineBtn = document.createElement('button');
                cancelEditInlineBtn.textContent = 'Cancel Edit';
                cancelEditInlineBtn.classList.add('button', 'small-action-btn', 'cancel-edit-inline-btn');
                cancelEditInlineBtn.style.backgroundColor = '#BDBDBD';
                cancelEditInlineBtn.addEventListener('click', () => {
                    inlineFormContainer.style.display = 'none'; 
                    inlineFormContainer.innerHTML = ''; 
                    updateEmployeeLineupCard(rosterLi, buttonClicked, shiftToEdit); 
                });
                formActionsDiv.appendChild(cancelEditInlineBtn);
            }
            rosterLi.scrollIntoView({ behavior: "smooth", block: "center" });
            if (timeInInline) timeInInline.focus();
        }, 50);
    }

    function handleRemoveLoggedShift(event) {
        const dataset = event.target.dataset;
        const shiftId = dataset.shiftid; 
        const shiftDate = dataset.date; 
        const empId = dataset.empid; 
        const posCtx = dataset.positioncontext; 

        if (!dailyShifts[shiftDate]) {
            if(empId && posCtx) {
                const liToUpdate = document.getElementById(`roster-emp-${empId}-${posCtx.replace(/\s+/g, '')}`);
                const btnToUpdate = liToUpdate ? liToUpdate.querySelector('.worked-today-toggle-btn') : null;
                if (liToUpdate && btnToUpdate) updateEmployeeLineupCard(liToUpdate, btnToUpdate, null);
            }
            return;
        }

        const shiftIndex = dailyShifts[shiftDate].findIndex(s => s.id === shiftId);
        if (shiftIndex > -1) {
            dailyShifts[shiftDate].splice(shiftIndex, 1); 
            if (dailyShifts[shiftDate].length === 0) delete dailyShifts[shiftDate];
            saveState(); 
        } 
        
        if (empId && posCtx) {
            const liToUpdate = document.getElementById(`roster-emp-${empId}-${posCtx.replace(/\s+/g, '')}`);
            const btnToUpdate = liToUpdate ? liToUpdate.querySelector('.worked-today-toggle-btn') : null;
            if(liToUpdate && btnToUpdate) {
                updateEmployeeLineupCard(liToUpdate, btnToUpdate, null);
            } else {
                renderEmployeeRoster(); 
            }
        } else {
             renderEmployeeRoster(); 
        }
        applyMasonryLayoutToRoster();
    }
    
    function runTipAndWageCalculationsForDay(shiftsForDay) {
        let processedShifts = shiftsForDay.map(s => {
            const exactHours = calculateHoursWorked(s.timeIn, s.timeOut); 
            const wage = exactHours * (s.shiftPayRate || 0);
            let tipDetails = {
                ccTips: 0, cashTips: 0, totalSales: 0, tipOutGiven: 0, tipInReceived: 0,
                detailedTipIns: [], tipsForTaxes: 0, tipsOnCheck: 0, totalPayoutOnCheck: 0 
            };
            if (s.positionWorked === "Server") {
                tipDetails.ccTips = s.ccTips || 0;
                tipDetails.cashTips = s.cashTips || 0;
                tipDetails.totalSales = s.totalSales || 0;
            }
            return {
                ...s, 
                hoursWorked: exactHours, 
                shiftWage: wage,       
                roundedTimeInForTips: roundToNearest15Minutes(s.timeIn),
                roundedTimeOutForTips: roundToNearest15Minutes(s.timeOut),
                ...tipDetails
            };
        });

        const serverShifts = processedShifts.filter(s => s.positionWorked === "Server");
        const supportStaffByType = {
            Busser: processedShifts.filter(s => s.positionWorked === "Busser"),
            FoodRunner: processedShifts.filter(s => s.positionWorked === "Food Runner"),
            ShakeSpinner: processedShifts.filter(s => s.positionWorked === "Shake Spinner"),
            Host: processedShifts.filter(s => s.positionWorked === "Host")
        };

        serverShifts.forEach(serverShift => {
            const serverRoundedStartMinutes = timeToMinutes(serverShift.roundedTimeInForTips);
            const serverRoundedEndMinutes = timeToMinutes(serverShift.roundedTimeOutForTips);
            const serverShiftDurationMinutesForTips = Math.max(0, serverRoundedEndMinutes - serverRoundedStartMinutes);

            if (serverShiftDurationMinutesForTips <= 0) return; 
            const serverSalesForTipOutBase = serverShift.totalSales;

            Object.entries({ Busser: 0.015, FoodRunner: 0.010, ShakeSpinner: 0.010 }).forEach(([supportRole, rate]) => {
                (supportStaffByType[supportRole] || []).forEach(supportShift => {
                    const tempServerShiftForTipOverlap = { timeIn: serverShift.roundedTimeInForTips, timeOut: serverShift.roundedTimeOutForTips };
                    const tempSupportShiftForTipOverlap = { timeIn: supportShift.roundedTimeInForTips, timeOut: supportShift.roundedTimeOutForTips };
                    const overlapMinutes = calculateOverlapDurationMinutes(tempServerShiftForTipOverlap, tempSupportShiftForTipOverlap);
                    if (overlapMinutes > 0) {
                        const proportionOfServerShiftCoveredBySupport = serverShiftDurationMinutesForTips > 0 ? (overlapMinutes / serverShiftDurationMinutesForTips) : 0;
                        let tipOutAmount = serverSalesForTipOutBase * rate * proportionOfServerShiftCoveredBySupport;
                        tipOutAmount = roundToNearestHalfDollar(tipOutAmount);
                        
                        serverShift.tipOutGiven += tipOutAmount;
                        supportShift.tipInReceived += tipOutAmount;
                        supportShift.detailedTipIns.push({ fromServerName: serverShift.employeeName, fromServerShiftTime: `${serverShift.timeIn}-${serverShift.timeOut}`, overlapMinutes: overlapMinutes, amount: tipOutAmount, supportShiftTime: `${supportShift.timeIn}-${supportShift.timeOut}` });
                    }
                });
            });

            (supportStaffByType.Host || []).forEach(hostShift => {
                const tempServerShiftForTipOverlap = { timeIn: serverShift.roundedTimeInForTips, timeOut: serverShift.roundedTimeOutForTips };
                const tempSupportShiftForTipOverlap = { timeIn: hostShift.roundedTimeInForTips, timeOut: hostShift.roundedTimeOutForTips };
                const overlapMinutes = calculateOverlapDurationMinutes(tempServerShiftForTipOverlap, tempSupportShiftForTipOverlap);
                if (overlapMinutes > 0) {
                    let hostTipOutAmount = 5.00; 
                    hostTipOutAmount = roundToNearestHalfDollar(hostTipOutAmount); 
                    
                    serverShift.tipOutGiven += hostTipOutAmount;
                    hostShift.tipInReceived += hostTipOutAmount;
                    hostShift.detailedTipIns.push({ fromServerName: serverShift.employeeName, fromServerShiftTime: `${serverShift.timeIn}-${serverShift.timeOut}`, overlapMinutes: overlapMinutes, amount: hostTipOutAmount, supportShiftTime: `${hostShift.timeIn}-${hostShift.timeOut}` });
                }
            });
        });
        
        processedShifts.forEach(shift => {
            shift.tipsForTaxes = (shift.ccTips || 0) + (shift.cashTips || 0) + (shift.tipInReceived || 0) - (shift.tipOutGiven || 0);
            shift.tipsOnCheck = (shift.ccTips || 0) + (shift.tipInReceived || 0) - (shift.tipOutGiven || 0);
            shift.totalPayoutOnCheck = shift.shiftWage + shift.tipsOnCheck;
            
             if (shift.positionWorked === "Server") { 
                 shift.finalTakeHomeTips = (shift.ccTips || 0) + (shift.cashTips || 0) - (shift.tipOutGiven || 0); 
             } else { 
                 shift.finalTakeHomeTips = shift.tipInReceived || 0;
            }
        });
        return processedShifts;
    }
    
    function renderDailyPayoutResults(processedShifts) { 
        if (!payoutResultsDiv) {console.error("Payout results div not found!"); return;}
        if (!processedShifts || processedShifts.length === 0) { 
            payoutResultsDiv.innerHTML = `<p>No shifts processed for ${formatDisplayDate(activeSelectedDate)}.</p>`;
            return;
        }

        let html = ''; 
        const groupedByPosition = processedShifts.reduce((acc, shift) => {
            const pos = shift.positionWorked;
            if (!acc[pos]) acc[pos] = [];
            acc[pos].push(shift);
            return acc;
        }, {});
        const positionOrder = ["Server", "Busser", "Food Runner", "Shake Spinner", "Host", ...Object.keys(groupedByPosition).filter(p => !JOB_POSITIONS_AVAILABLE.includes(p))];

        positionOrder.forEach(posKey => {
            if (groupedByPosition[posKey] && groupedByPosition[posKey].length > 0) {
                html += `<h5 class="report-position-group-header">${posKey}s:</h5>`;
                html += `<div class="data-table-container" style="overflow-x:auto;"><table class="data-results-table"><thead><tr><th>Employee</th><th>Shift Time</th><th>Hrs</th><th>Wage</th><th>Sales</th><th>CC Tips</th><th>Cash Tips</th><th>Tip Out</th><th>Tip In</th><th>Take-Home Tips</th><th>Action</th></tr></thead><tbody>`;
                groupedByPosition[posKey].sort((a,b) => sortEmployeesByName(a,b,'employeeName')).forEach((pShift, index) => { 
                    html += `<tr>
                                     <td data-label="Employee">${pShift.employeeName}</td>
                                     <td data-label="Shift Time">${formatTimeTo12Hour(pShift.timeIn)} - ${formatTimeTo12Hour(pShift.timeOut)}</td>
                                     <td data-label="Hrs">${pShift.hoursWorked.toFixed(2)}</td>
                                     <td data-label="Wage">$${pShift.shiftWage.toFixed(2)}</td>
                                     <td data-label="Sales">${pShift.positionWorked === "Server" ? `$${(pShift.totalSales || 0).toFixed(2)}` : 'N/A'}</td>
                                     <td data-label="CC Tips">${pShift.positionWorked === "Server" ? `$${(pShift.ccTips || 0).toFixed(2)}` : 'N/A'}</td>
                                     <td data-label="Cash Tips">${pShift.positionWorked === "Server" ? `$${(pShift.cashTips || 0).toFixed(2)}` : 'N/A'}</td>
                                     <td data-label="Tip Out">${pShift.positionWorked === "Server" ? `$${(pShift.tipOutGiven || 0).toFixed(2)}` : 'N/A'}</td>
                                     <td data-label="Tip In">${pShift.positionWorked !== "Server" ? `$${(pShift.tipInReceived || 0).toFixed(2)}` : 'N/A'}</td>
                                     <td data-label="Take-Home Tips"><strong>$${(pShift.finalTakeHomeTips || 0).toFixed(2)}</strong></td>
                                     <td data-label="Action">
                                         <button class="button small-action-btn remove-shift-from-scoop-btn"
                                                 data-shift-id="${pShift.id}"
                                                 data-date="${pShift.date}" 
                                                 data-empid="${pShift.employeeId}"
                                                 data-positioncontext="${pShift.positionWorked}"
                                                 title="Remove this shift permanently"
                                                 style="background-color: #c62828; font-size: 0.8em; padding: 4px 8px; margin-top:0;">
                                             Del
                                         </button>
                                     </td>
                                 </tr>`;

                    if (pShift.positionWorked !== "Server" && pShift.detailedTipIns && pShift.detailedTipIns.length > 0) {
                        html += `<tr class="detailed-tip-in-row-daily ${index % 2 === 1 ? 'even-detail' : 'odd-detail'}"><td colspan="11">`; 
                        html += '<ul class="support-tip-detail" style="margin:2px 0 2px 30px;padding-left:5px;list-style-type:circle;">';
                        pShift.detailedTipIns.forEach(detail => {
                            let fST = 'N/A'; if (detail.fromServerShiftTime && detail.fromServerShiftTime.includes('-')) { const [sIn, sOut] = detail.fromServerShiftTime.split('-'); fST = `${formatTimeTo12Hour(sIn)}-${formatTimeTo12Hour(sOut)}`; }
                            let supST = 'N/A'; if (detail.supportShiftTime && detail.supportShiftTime.includes('-')) { const [supIn, supOut] = detail.supportShiftTime.split('-'); supST = `${formatTimeTo12Hour(supIn)}-${formatTimeTo12Hour(supOut)}`; }
                            html += `<li>From ${detail.fromServerName} (Server ${fST}, ${detail.overlapMinutes.toFixed(0)}m overlap with your ${supST}): <strong>$${detail.amount.toFixed(2)}</strong></li>`;
                        });
                        html += '</ul></td></tr>';
                    }
                });
                html += `</tbody></table></div>`;
            }
        });
        payoutResultsDiv.innerHTML = html;

        payoutResultsDiv.querySelectorAll('.remove-shift-from-scoop-btn').forEach(btn => {
            btn.addEventListener('click', handleRemoveShiftFromDailyScoop);
        });
    }

    function handleRemoveShiftFromDailyScoop(event) {
        const button = event.currentTarget; 
        const shiftId = button.dataset.shiftId;
        const shiftDate = button.dataset.date; 
        const empId = button.dataset.empid;
        const posCtx = button.dataset.positioncontext;

        if (!shiftId || !shiftDate) { alert("Error: Cannot identify shift to remove."); return; }
        
        const employee = employeeRoster.find(e => e.id === empId);
        const empNameDisplay = employee ? employee.name : `Employee ID ${empId}`;

        if (confirm(`Are you sure you want to remove the shift for ${empNameDisplay} (${posCtx}) on ${formatDisplayDate(shiftDate)}?\nThis action cannot be undone.`)) {
            if (dailyShifts[shiftDate]) {
                const shiftIndex = dailyShifts[shiftDate].findIndex(s => s.id === shiftId);
                if (shiftIndex > -1) {
                    dailyShifts[shiftDate].splice(shiftIndex, 1);
                    if (dailyShifts[shiftDate].length === 0) { delete dailyShifts[shiftDate]; }
                    saveState(); 
                } else {
                    alert("Error: Shift not found. It might have already been removed.");
                    const currentShifts = dailyShifts[shiftDate] || [];
                    renderDailyPayoutResults(runTipAndWageCalculationsForDay(currentShifts));
                }
            } else {
                alert("Error: No shifts found for this date.");
                payoutResultsDiv.innerHTML = `<p>No shifts logged for ${formatDisplayDate(shiftDate)}.</p>`; 
            }
        }
    }
    
    prevWeekBtn.addEventListener('click', () => { 
        if(currentReportWeekStartDate){
            currentReportWeekStartDate.setUTCDate(currentReportWeekStartDate.getUTCDate()-7);
            
            const { cycleStart, weekNum } = findCycleAndWeekForDatePrecise(currentReportWeekStartDate);
            if (cycleStart && weekNum && cycleStartDateSelect.querySelector(`option[value="${cycleStart}"]`)) {
                cycleStartDateSelect.value = cycleStart;
                weekInCycleSelect.value = String(weekNum);
                calculateAndUpdateCurrentDate(1); 
            } else {
                console.error("Could not find matching cycle/week for new prev week date:", currentReportWeekStartDate);
                currentReportWeekStartDate.setUTCDate(currentReportWeekStartDate.getUTCDate()+7); 
                alert("Could not navigate to the previous week. It might be out of the configured cycle range.");
            }
        }
    });
    nextWeekBtn.addEventListener('click', () => { 
         if(currentReportWeekStartDate){
            currentReportWeekStartDate.setUTCDate(currentReportWeekStartDate.getUTCDate()+7);
            const { cycleStart, weekNum } = findCycleAndWeekForDatePrecise(currentReportWeekStartDate);
            if (cycleStart && weekNum && cycleStartDateSelect.querySelector(`option[value="${cycleStart}"]`)) {
                cycleStartDateSelect.value = cycleStart;
                weekInCycleSelect.value = String(weekNum);
                calculateAndUpdateCurrentDate(1);
            } else {
                 console.error("Could not find matching cycle/week for new next week date:", currentReportWeekStartDate);
                 currentReportWeekStartDate.setUTCDate(currentReportWeekStartDate.getUTCDate()-7); 
                 alert("Could not navigate to the next week. It might be out of the configured cycle range.");
            }
        }
    });
    
    function handleEditShiftFromWeeklyReport(event) {
        const button = event.currentTarget;
        const shiftIdToEdit = button.dataset.shiftId;
        const shiftDate = button.dataset.date;
        const employeeId = button.dataset.empid;
        const positionContext = button.dataset.positioncontext;

        if (!shiftIdToEdit || !shiftDate || !employeeId || !positionContext) {
            alert("Error: Could not get all necessary details to edit the shift."); return;
        }

        const targetDateObj = new Date(shiftDate + 'T00:00:00Z');
        const { cycleStart, weekNum } = findCycleAndWeekForDatePrecise(targetDateObj);


        if (!cycleStart || !weekNum || !cycleStartDateSelect.querySelector(`option[value="${cycleStart}"]`)) {
             alert("Error: Could not automatically set date controls. Please navigate manually."); return;
        }
        
        cycleStartDateSelect.value = cycleStart;
        weekInCycleSelect.value = String(weekNum);
        let dayOfWeekNum = targetDateObj.getUTCDay(); 
        currentSelectedDayOfWeek = dayOfWeekNum; 
        calculateAndUpdateCurrentDate(dayOfWeekNum); 

        const lineupSectionContent = document.getElementById('lineupContent');
        const lineupSectionHeader = lineupSectionContent.previousElementSibling;
        if (lineupSectionContent.style.display === 'none' && lineupSectionHeader?.classList.contains('collapsible-header')) lineupSectionHeader.click(); 
        
        employeeLineupSection.style.display = 'block'; 
        if(employeeFormSection) employeeFormSection.style.display = 'none'; 
        employeeLineupSection.scrollIntoView({ behavior: 'smooth', block: 'start'});

        setTimeout(() => {
            const rosterLiId = `roster-emp-${employeeId}-${positionContext.replace(/\s+/g, '')}`;
            const targetLi = document.getElementById(rosterLiId);
            if (targetLi) {
                const toggleButton = targetLi.querySelector('.worked-today-toggle-btn');
                if (toggleButton) {
                    const currentShiftInLineup = dailyShifts[activeSelectedDate]?.find(s => s.id === shiftIdToEdit && s.employeeId === employeeId && s.positionWorked === positionContext);
                    if(currentShiftInLineup){ 
                        updateEmployeeLineupCard(targetLi, toggleButton, currentShiftInLineup); 
                        if (toggleButton.dataset.action === "edit" && toggleButton.dataset.shiftId === shiftIdToEdit) {
                           toggleButton.click(); 
                           setTimeout(() => targetLi.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
                        }
                    } else {
                         alert("Shift not found in The Lineup for this day/position. It may have been deleted or changed.");
                    }
                }
            } else {
                alert("Error: Could not find the employee's entry in The Lineup.");
            }
        }, 350); 
    }
    
    function generateWeeklyReportContent() {
        if (!currentReportWeekStartDate) {
            if(reportOutputDiv) reportOutputDiv.innerHTML = "<p>Use date selector to establish a week context first.</p>"; return;
        }
        if(reportOutputDiv) reportOutputDiv.innerHTML = ''; 

        currentWeeklyDataForExport = [];
        const csvHeaders = ["Date", "Day of Week", "Week # Cycle", "Emp Name", "Position", "Pay Rate", "Time In", "Time Out", "Hrs", "Total Sales", "Wage", "CC Tips", "Cash Tips", "Tip Out", "Tip In", "Tips for Taxes", "Tips on Check", "Total Payout on Check"];
        currentWeeklyDataForExport.push(csvHeaders);

        const weeklyEmployeeSummaryData = {}; 
        const weekStartObj = new Date(currentReportWeekStartDate);

        for (let i = 0; i < 7; i++) {
            const currentDayIter = new Date(weekStartObj);
            currentDayIter.setUTCDate(weekStartObj.getUTCDate() + i);
            const dayStr = formatDate(currentDayIter);
            const shiftsForThisDayRaw = dailyShifts[dayStr] || [];
            if (shiftsForThisDayRaw.length > 0) {
                const processedShiftsForDay = runTipAndWageCalculationsForDay(shiftsForThisDayRaw);
                processedShiftsForDay.forEach(pShift => {
                    if (!pShift.employeeId || !pShift.employeeName) { return; }
                    if (!weeklyEmployeeSummaryData[pShift.employeeId]) {
                        weeklyEmployeeSummaryData[pShift.employeeId] = {
                            employeeId: pShift.employeeId,
                            employeeName: pShift.employeeName,
                            totalWeeklyWages: 0,
                            totalWeeklyTipsForTaxes: 0,
                            totalWeeklyTipsOnCheck: 0,
                            totalWeeklyPayoutOnCheck: 0
                        };
                    }
                    const summaryEntry = weeklyEmployeeSummaryData[pShift.employeeId];
                    summaryEntry.totalWeeklyWages += pShift.shiftWage;
                    summaryEntry.totalWeeklyTipsForTaxes += pShift.tipsForTaxes;
                    summaryEntry.totalWeeklyTipsOnCheck += pShift.tipsOnCheck;
                    summaryEntry.totalWeeklyPayoutOnCheck += pShift.totalPayoutOnCheck;
                });
            }
        }

        const employeeSummaryArray = Object.values(weeklyEmployeeSummaryData);
        employeeSummaryArray.sort((a, b) => sortEmployeesByName(a, b, 'employeeName'));
        
        let weeklyHTML = ''; 

        if (employeeSummaryArray.length > 0) {
            weeklyHTML += `<h4>Weekly Employee Totals:</h4>`;
            weeklyHTML += `<div class="data-table-container" style="overflow-x:auto; margin-bottom: 25px;"><table class="data-results-table">
                <thead><tr><th>Employee</th><th>Total Wages</th><th>Tips for Taxes</th><th>Tips on Check</th><th>Total Payout on Check</th></tr></thead><tbody>`;
            employeeSummaryArray.forEach(empSummary => {
                weeklyHTML += `<tr>
                    <td data-label="Employee">${empSummary.employeeName}</td>
                    <td data-label="Total Wages">$${empSummary.totalWeeklyWages.toFixed(2)}</td>
                    <td data-label="Tips for Taxes">$${empSummary.totalWeeklyTipsForTaxes.toFixed(2)}</td>
                    <td data-label="Tips on Check">$${empSummary.totalWeeklyTipsOnCheck.toFixed(2)}</td>
                    <td data-label="Total Payout"><strong>$${empSummary.totalWeeklyPayoutOnCheck.toFixed(2)}</strong></td>
                </tr>`;
            });
            weeklyHTML += `</tbody></table></div>`;
        } else {
            weeklyHTML += `<p><em>No employee activity recorded for this week to summarize.</em></p>`;
        }
        weeklyHTML += `<hr style="margin: 25px 0; border-top: 2px dashed var(--border-color);">`;

        const daysOfWeekNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        for (let i = 0; i < 7; i++) {
            const currDayProc = new Date(weekStartObj);
            currDayProc.setUTCDate(weekStartObj.getUTCDate() + i);
            const dStr = formatDate(currDayProc);
            const dayName = daysOfWeekNames[currDayProc.getUTCDay()];
            weeklyHTML += `<h4 class="report-day-header">${dayName}, ${formatDisplayDate(dStr)}</h4>`;

            const shiftsTodayRaw = dailyShifts[dStr] || [];
            if (shiftsTodayRaw.length === 0) { weeklyHTML += "<p><em>No shifts logged.</em></p>"; continue; }

            const procShiftsToday = runTipAndWageCalculationsForDay(shiftsTodayRaw);
            procShiftsToday.sort((a,b) => sortEmployeesByName(a,b, 'employeeName')); 

            if (procShiftsToday.length > 0) {
                weeklyHTML += `<div class="data-table-container" style="overflow-x:auto;"><table class="data-results-table">
                    <thead><tr>
                        <th>Emp</th><th>Shift Time</th><th>Hrs</th><th>Wage</th><th>CC Tips</th><th>Cash Tips</th><th>Tip Out</th><th>Tip In</th><th>Tips for Taxes</th><th>Action</th>
                    </tr></thead><tbody>`;
                procShiftsToday.forEach(ps => {
                    weeklyHTML += `<tr>
                        <td data-label="Emp" title="${ps.employeeName}">${ps.employeeName.length > 18 ? ps.employeeName.substring(0,16)+"..." : ps.employeeName}</td>
                        <td data-label="Shift Time">${formatTimeTo12Hour(ps.timeIn)}-${formatTimeTo12Hour(ps.timeOut)}</td>
                        <td data-label="Hrs">${ps.hoursWorked.toFixed(2)}</td>
                        <td data-label="Wage">$${ps.shiftWage.toFixed(2)}</td>
                        <td data-label="CC Tips">${ps.positionWorked === "Server" ? `$${(ps.ccTips || 0).toFixed(2)}` : 'N/A'}</td>
                        <td data-label="Cash Tips">${ps.positionWorked === "Server" ? `$${(ps.cashTips || 0).toFixed(2)}` : 'N/A'}</td>
                        <td data-label="Tip Out">${ps.positionWorked === "Server" ? `$${(ps.tipOutGiven || 0).toFixed(2)}` : 'N/A'}</td>
                        <td data-label="Tip In">${ps.positionWorked !== "Server" ? `$${(ps.tipInReceived || 0).toFixed(2)}` : 'N/A'}</td>
                        <td data-label="Tips for Taxes">$${(ps.tipsForTaxes || 0).toFixed(2)}</td>
                        <td data-label="Action">
                            <button class="button small-action-btn edit-shift-from-weekly-btn"
                                    data-shift-id="${ps.id}" data-date="${ps.date}" data-empid="${ps.employeeId}" data-positioncontext="${ps.positionWorked}" 
                                    style="font-size: 0.8em; padding: 4px 6px; margin-top:0; background-color: var(--accent-black);" title="Edit this shift">
                                Edit
                            </button>
                        </td>
                    </tr>`;
                    currentWeeklyDataForExport.push([
                        dStr, dayName, getWeekInfo(dStr).weekInCycle, ps.employeeName, ps.positionWorked,
                        (ps.shiftPayRate || 0).toFixed(2), formatTimeTo12Hour(ps.timeIn), formatTimeTo12Hour(ps.timeOut),
                        ps.hoursWorked.toFixed(2), (ps.totalSales || 0).toFixed(2), ps.shiftWage.toFixed(2),
                        ps.positionWorked === "Server" ? (ps.ccTips || 0).toFixed(2) : '',
                        ps.positionWorked === "Server" ? (ps.cashTips || 0).toFixed(2) : '',
                        ps.positionWorked === "Server" ? (ps.tipOutGiven || 0).toFixed(2) : '',
                        ps.positionWorked !== "Server" ? (ps.tipInReceived || 0).toFixed(2) : '',
                        (ps.tipsForTaxes || 0).toFixed(2), (ps.tipsOnCheck || 0).toFixed(2), (ps.totalPayoutOnCheck || 0).toFixed(2)
                    ]);
                });
                weeklyHTML += `</tbody></table></div>`;
            }
        }
        if(reportOutputDiv) reportOutputDiv.innerHTML = weeklyHTML;
        if(exportWeeklyCSVBtn) exportWeeklyCSVBtn.style.display = currentWeeklyDataForExport.length > 1 ? 'inline-block' : 'none';

        if(reportOutputDiv) {
            reportOutputDiv.querySelectorAll('.edit-shift-from-weekly-btn').forEach(btn => {
                btn.addEventListener('click', handleEditShiftFromWeeklyReport);
            });
        }
    }

    exportWeeklyCSVBtn.addEventListener('click', () => { 
        if(!currentReportWeekStartDate) {
            alert("Please ensure a week is selected in the 'Weekly Rewind' section first.");
            return;
        }
        exportToXLSX(); // Call the new XLSX export function
    });
    
    function exportToXLSX() {
        const wb = XLSX.utils.book_new();
        const daysOrder = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dayValues = [1, 2, 3, 4, 5, 6, 0]; // Corresponding getUTCDay values for Mon-Sun

        const headerStyle = {
            font: { color: { rgb: "FFFFFF" }, bold: true },
            fill: { fgColor: { rgb: "E53935" } }, // Red
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { auto: 1 } }, bottom: { style: "thin", color: { auto: 1 } },
                left: { style: "thin", color: { auto: 1 } }, right: { style: "thin", color: { auto: 1 } }
            }
        };
        const cellStyle = {
            border: {
                top: { style: "thin", color: { auto: 1 } }, bottom: { style: "thin", color: { auto: 1 } },
                left: { style: "thin", color: { auto: 1 } }, right: { style: "thin", color: { auto: 1 } }
            }
        };
         const zebraStripeEven = { fill: { fgColor: { rgb: "FFF9C4" } } }; // Light cream for even data rows (after header)
         const zebraStripeOdd = { fill: { fgColor: { rgb: "FFFFFF" } } };  // White for odd data rows


        // 1. Daily Sheets
        for (let i = 0; i < 7; i++) {
            const dayToProcess = new Date(currentReportWeekStartDate);
            dayToProcess.setUTCDate(currentReportWeekStartDate.getUTCDate() + i);
            const dayString = formatDate(dayToProcess);
            const sheetName = daysOrder[dayValues.indexOf(dayToProcess.getUTCDay())] || `Day ${i+1}`; // Fallback sheet name

            const shiftsForDay = dailyShifts[dayString] || [];
            let sheetData = [];
            const dailyHeaders = ["Emp", "Position", "Shift Time", "Hrs", "Wage", "Total Sales", "CC Tips", "Cash Tips", "Tip Out", "Tip In", "Tips for Taxes"];
            sheetData.push(dailyHeaders);

            if (shiftsForDay.length > 0) {
                const processedDailyShifts = runTipAndWageCalculationsForDay(shiftsForDay);
                processedDailyShifts.sort((a,b) => sortEmployeesByName(a,b,'employeeName'));
                processedDailyShifts.forEach(ps => {
                    sheetData.push([
                        ps.employeeName,
                        ps.positionWorked,
                        `${formatTimeTo12Hour(ps.timeIn)}-${formatTimeTo12Hour(ps.timeOut)}`,
                        ps.hoursWorked.toFixed(2),
                        ps.shiftWage.toFixed(2),
                        ps.positionWorked === "Server" ? (ps.totalSales || 0).toFixed(2) : '',
                        ps.positionWorked === "Server" ? (ps.ccTips || 0).toFixed(2) : '',
                        ps.positionWorked === "Server" ? (ps.cashTips || 0).toFixed(2) : '',
                        ps.positionWorked === "Server" ? (ps.tipOutGiven || 0).toFixed(2) : '',
                        ps.positionWorked !== "Server" ? (ps.tipInReceived || 0).toFixed(2) : '',
                        (ps.tipsForTaxes || 0).toFixed(2)
                    ]);
                });
            } else {
                sheetData.push(["No shifts logged for this day."]); // Add a placeholder if no shifts
            }

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            
            // Apply Styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) { // Header row
                const cellAddress = XLSX.utils.encode_cell({r: 0, c: C});
                if(!ws[cellAddress]) ws[cellAddress] = {v: ""}; // Ensure cell exists
                ws[cellAddress].s = headerStyle;
            }
            for (let R = 1; R <= range.e.r; ++R) { // Data rows
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    if(!ws[cellAddress]) ws[cellAddress] = {v: ""};
                    ws[cellAddress].s = cellStyle;
                     if (R % 2 !== 0) { // Odd data rows (1, 3, 5...)
                         ws[cellAddress].s = {...ws[cellAddress].s, ...zebraStripeOdd };
                    } else { // Even data rows (2, 4, 6...)
                         ws[cellAddress].s = {...ws[cellAddress].s, ...zebraStripeEven};
                    }
                }
            }

            // Auto-fit columns (basic attempt)
            const colWidths = dailyHeaders.map((_, i) => ({wch: 15})); // Default width
            sheetData.forEach(row => {
                row.forEach((cell, j) => {
                    const len = cell ? String(cell).length + 2 : 10;
                    if (colWidths[j].wch < len) colWidths[j].wch = len;
                });
            });
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }

        // 2. Week Totals Sheet
        let weeklySummarySheetData = [];
        const weeklyTotalHeaders = ["Employee", "Total Wages", "Tips for Taxes", "Tips on Check", "Total Payout on Check"];
        weeklySummarySheetData.push(weeklyTotalHeaders);

        // Re-calculate or fetch weeklyEmployeeSummaryData (as it's scoped to generateWeeklyReportContent)
        const weeklySummaryDataForExport = {};
        const weekStartForTotals = new Date(currentReportWeekStartDate);
         for (let i = 0; i < 7; i++) {
            const currentDayIter = new Date(weekStartForTotals);
            currentDayIter.setUTCDate(weekStartForTotals.getUTCDate() + i);
            const dayStr = formatDate(currentDayIter);
            const shiftsForThisDayRaw = dailyShifts[dayStr] || [];
            if (shiftsForThisDayRaw.length > 0) {
                const processedShiftsForDay = runTipAndWageCalculationsForDay(shiftsForThisDayRaw);
                processedShiftsForDay.forEach(pShift => {
                    if (!pShift.employeeId || !pShift.employeeName) { return; }
                    if (!weeklySummaryDataForExport[pShift.employeeId]) {
                        weeklySummaryDataForExport[pShift.employeeId] = {
                            employeeId: pShift.employeeId, employeeName: pShift.employeeName,
                            totalWeeklyWages: 0, totalWeeklyTipsForTaxes: 0,
                            totalWeeklyTipsOnCheck: 0, totalWeeklyPayoutOnCheck: 0
                        };
                    }
                    const summaryEntry = weeklySummaryDataForExport[pShift.employeeId];
                    summaryEntry.totalWeeklyWages += pShift.shiftWage;
                    summaryEntry.totalWeeklyTipsForTaxes += pShift.tipsForTaxes;
                    summaryEntry.totalWeeklyTipsOnCheck += pShift.tipsOnCheck;
                    summaryEntry.totalWeeklyPayoutOnCheck += pShift.totalPayoutOnCheck;
                });
            }
        }
        const employeeSummaryArrayForExport = Object.values(weeklySummaryDataForExport);
        employeeSummaryArrayForExport.sort((a, b) => sortEmployeesByName(a, b, 'employeeName'));

        employeeSummaryArrayForExport.forEach(empSummary => {
            weeklySummarySheetData.push([
                empSummary.employeeName,
                empSummary.totalWeeklyWages.toFixed(2),
                empSummary.totalWeeklyTipsForTaxes.toFixed(2),
                empSummary.totalWeeklyTipsOnCheck.toFixed(2),
                empSummary.totalWeeklyPayoutOnCheck.toFixed(2)
            ]);
        });
        
        if (employeeSummaryArrayForExport.length === 0) {
            weeklySummarySheetData.push(["No data for this week."]);
        }

        const ws_totals = XLSX.utils.aoa_to_sheet(weeklySummarySheetData);
        // Apply Styling to Totals sheet
        const range_totals = XLSX.utils.decode_range(ws_totals['!ref']);
        for (let C = range_totals.s.c; C <= range_totals.e.c; ++C) { // Header row
            const cellAddress = XLSX.utils.encode_cell({r: 0, c: C});
            if(!ws_totals[cellAddress]) ws_totals[cellAddress] = {v: ""};
            ws_totals[cellAddress].s = headerStyle;
        }
        for (let R = 1; R <= range_totals.e.r; ++R) { // Data rows
            for (let C = range_totals.s.c; C <= range_totals.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                 if(!ws_totals[cellAddress]) ws_totals[cellAddress] = {v: ""};
                ws_totals[cellAddress].s = cellStyle;
                 if (R % 2 !== 0) { 
                     ws_totals[cellAddress].s = {...ws_totals[cellAddress].s, ...zebraStripeOdd };
                } else { 
                     ws_totals[cellAddress].s = {...ws_totals[cellAddress].s, ...zebraStripeEven};
                }
            }
        }
        const colWidthsTotals = weeklyTotalHeaders.map((_, i) => ({wch: 20})); // Default width
        weeklySummarySheetData.forEach(row => {
            row.forEach((cell, j) => {
                const len = cell ? String(cell).length + 2 : 10;
                if (colWidthsTotals[j].wch < len) colWidthsTotals[j].wch = len;
            });
        });
        ws_totals['!cols'] = colWidthsTotals;


        XLSX.utils.book_append_sheet(wb, ws_totals, "Week Totals");

        // Trigger download
        const weekStartStrExport = formatDate(currentReportWeekStartDate);
        XLSX.writeFile(wb, `WeeklyReport_${weekStartStrExport}.xlsx`);
    }

    // --- DATA MANAGEMENT FUNCTIONS ---
    function downloadSaveState() {
        console.log("APP_LOG: Preparing to download save state.");
        try {
            const stateToSave = {
                employeeRoster: employeeRoster,
                dailyShifts: dailyShifts
            };

            const jsonString = JSON.stringify(stateToSave, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            const today = new Date().toISOString().slice(0, 10);
            a.download = `diner-tipsplit-save-${today}.json`;
            
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
            console.log("APP_LOG: Save state download initiated.");

        } catch (error) {
            console.error("Error creating save state file:", error);
            alert("An error occurred while creating the save file. Please check the console for details.");
        }
    }

    function loadSaveState(event) {
        const file = event.target.files[0];
        if (!file) {
            return; // No file selected
        }
        console.log(`APP_LOG: Loading save state from file: ${file.name}`);

        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const loadedState = JSON.parse(e.target.result);

                // Basic validation to ensure the file is a valid save state
                if (loadedState && typeof loadedState.employeeRoster === 'object' && typeof loadedState.dailyShifts === 'object') {
                    if (confirm("Are you sure you want to load this file? This will overwrite all current data.")) {
                        // Directly set the data in localStorage
                        localStorage.setItem('dinerTipSplit_employeeRosterV2', JSON.stringify(loadedState.employeeRoster));
                        localStorage.setItem('dinerTipSplit_dailyShiftsV2', JSON.stringify(loadedState.dailyShifts));
                        
                        alert('Save state loaded successfully! The page will now reload to apply the changes.');
                        location.reload(); // Reload the page to re-initialize the app with the new data
                    }
                } else {
                    alert('Error: The selected file does not appear to be a valid save state for this application.');
                }
            } catch (error) {
                console.error("Error parsing save state file:", error);
                alert("An error occurred while reading the file. It may be corrupted or not a valid JSON file.");
            } finally {
                // Reset the file input so the user can load the same file again if needed
                event.target.value = '';
            }
        };
        
        reader.onerror = () => {
             alert(`An error occurred while reading the file: ${reader.error}`);
             event.target.value = '';
        };

        reader.readAsText(file);
    }
    
    // --- TUTORIAL FUNCTIONS (REVISED) ---
    function startTutorial(tutorialKey) {
        currentTutorialSteps = tutorials[tutorialKey] || [];
        if (currentTutorialSteps.length === 0) {
            console.error("Tutorial not found for key:", tutorialKey);
            return;
        }

        currentTutorialStepIndex = 0;
        tutorialOverlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
        showTutorialStep(currentTutorialStepIndex);
        
        if (tutorialAnimationId) cancelAnimationFrame(tutorialAnimationId);
        tutorialAnimationLoop();
    }

    function closeTutorial() {
        tutorialOverlay.style.display = 'none';
        tutorialHighlightBox.style.display = 'none';
        tutorialTextBox.style.display = 'none';
        document.body.style.overflow = '';

        if (tutorialAnimationId) cancelAnimationFrame(tutorialAnimationId);
        tutorialAnimationId = null;
        currentTutorialTargetElement = null;
    }
    
    function ensureElementIsVisible(element, callback) {
        if (!element) {
            if (callback) callback();
            return;
        }

        const section = element.closest('.section-card');
        if (section) {
            const content = section.querySelector('.collapsible-content');
            const header = section.querySelector('.collapsible-header');

            if (content && header && content.style.display === 'none') {
                header.click();
                setTimeout(() => { if (callback) callback(); }, 350); // Wait for animation
                return;
            }
        }
        if (callback) callback();
    }

    function updateTutorialHighlight(targetEl) {
        if (!targetEl || !targetEl.offsetParent || tutorialOverlay.style.display === 'none') {
            tutorialHighlightBox.style.display = 'none';
            // Center the text box if the element disappears
            tutorialTextBox.style.display = 'block';
            tutorialTextBox.style.top = '50%';
            tutorialTextBox.style.left = '50%';
            tutorialTextBox.style.transform = 'translate(-50%, -50%)';
            return;
        }

        const rect = targetEl.getBoundingClientRect();
        
        tutorialHighlightBox.style.display = 'block';
        tutorialHighlightBox.style.top = `${rect.top - 5}px`;
        tutorialHighlightBox.style.left = `${rect.left - 5}px`;
        tutorialHighlightBox.style.width = `${rect.width + 10}px`;
        tutorialHighlightBox.style.height = `${rect.height + 10}px`;

        tutorialTextBox.style.display = 'block';
        const textRect = tutorialTextBox.getBoundingClientRect();

        let textTop = rect.bottom + 15;
        if (textTop + textRect.height > window.innerHeight - 10) {
            textTop = rect.top - textRect.height - 15;
        }
        if (textTop < 10) {
            textTop = 10;
        }
        
        let textLeft = rect.left + (rect.width / 2) - (textRect.width / 2);
        if (textLeft < 10) textLeft = 10;
        if (textLeft + textRect.width > window.innerWidth - 10) {
            textLeft = window.innerWidth - textRect.width - 10;
        }

        tutorialTextBox.style.top = `${textTop}px`;
        tutorialTextBox.style.left = `${textLeft}px`;
        tutorialTextBox.style.transform = 'none';
    }

    function tutorialAnimationLoop() {
        if (tutorialOverlay.style.display === 'block' && currentTutorialTargetElement) {
            updateTutorialHighlight(currentTutorialTargetElement);
        }
        tutorialAnimationId = requestAnimationFrame(tutorialAnimationLoop);
    }


    function showTutorialStep(index) {
        if (index < 0 || index >= currentTutorialSteps.length) {
            closeTutorial();
            return;
        }

        currentTutorialStepIndex = index;
        const step = currentTutorialSteps[index];

        tutorialTitle.textContent = step.title;
        tutorialText.textContent = step.text;
        tutorialStepCounter.textContent = `${index + 1} / ${currentTutorialSteps.length}`;
        tutorialPrevBtn.disabled = index === 0;
        tutorialNextBtn.disabled = index === currentTutorialSteps.length - 1;
        tutorialNextBtn.textContent = index === currentTutorialSteps.length - 1 ? 'Finish' : 'Next »';
        
        const findAndPrepareStep = () => {
            const el = document.querySelector(step.element) || document.querySelector(step.fallbackElement);
            currentTutorialTargetElement = el; // Set the global target for the animation loop

            if (!el) {
                console.warn("Tutorial element could not be found for step:", step);
                currentTutorialTargetElement = null; // Unset so loop doesn't track it
                updateTutorialHighlight(null); // Position text box in center
            } else {
                 el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 // The animation loop will handle positioning
            }
        };
        
        let initialElement = document.querySelector(step.element) || document.querySelector(step.fallbackElement);
        ensureElementIsVisible(initialElement, () => {
            if (step.isDynamic) {
                const trigger = document.querySelector(step.dynamicTrigger);
                if (trigger && typeof trigger.click === 'function') {
                     const form = trigger.closest('li')?.querySelector('.inline-shift-form-container');
                     if(!form || form.style.display === 'none') {
                         trigger.click();
                     }
                }
                setTimeout(findAndPrepareStep, 450); // Wait for DOM updates
            } else {
                findAndPrepareStep();
            }
        });
    }


    // --- App Initialization ---
    console.log("APP_LOG: Starting initializations...");

    // Event listeners for data management
    downloadStateBtn.addEventListener('click', downloadSaveState);
    loadStateFileInput.addEventListener('change', loadSaveState);

    // Event Listeners for Tutorial Buttons
    document.querySelectorAll('.tutorial-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); // Stop the click from bubbling up to the collapsible header
            const tutorialKey = e.target.dataset.tutorialFor;
            startTutorial(tutorialKey);
        });
    });

    tutorialCloseBtn.addEventListener('click', closeTutorial);
    tutorialNextBtn.addEventListener('click', () => showTutorialStep(currentTutorialStepIndex + 1));
    tutorialPrevBtn.addEventListener('click', () => showTutorialStep(currentTutorialStepIndex - 1));
    // Close tutorial with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape" && tutorialOverlay.style.display === 'block') {
            closeTutorial();
        }
    });


    populateCycleStartDateSelect(); 
    const todayForDefaults = new Date(); 
    currentSelectedDayOfWeek = todayForDefaults.getUTCDay() === 0 ? 0 : todayForDefaults.getUTCDay(); 
    if(currentSelectedDayOfWeek === 0 && new Date().getDay() !== 0){ 
        currentSelectedDayOfWeek = 1;
    }

    const initialCycleStart = cycleStartDateSelect.value;
    if(initialCycleStart) {
        const todayWeekInfo = getWeekInfo(formatDate(todayForDefaults)); 
        const defaultCycleStartDateObj = new Date(initialCycleStart + "T00:00:00Z");
        const defaultCycleEndDateObj = new Date(defaultCycleStartDateObj); defaultCycleEndDateObj.setUTCDate(defaultCycleStartDateObj.getUTCDate() + 27);
        if (todayForDefaults >= defaultCycleStartDateObj && todayForDefaults <= defaultCycleEndDateObj && todayWeekInfo.weekInCycle >= 1 && todayWeekInfo.weekInCycle <= 4) {
             weekInCycleSelect.value = String(todayWeekInfo.weekInCycle);
        } else { weekInCycleSelect.value = "1"; }
    } else { weekInCycleSelect.value = "1"; }
    
    calculateAndUpdateCurrentDate(currentSelectedDayOfWeek); 
    initializeCollapsibleSections(); 
    renderEmpPositionsWithPayRates(); 
    console.log("APP_LOG: Initializations complete.");
});
</script>
</body>
</html>
