Refactoring Guide & Functional Specification: Toody's TipSplit Deluxe
0. Introduction & Refactoring Goals
0.1. Document Purpose
This document provides a complete functional and technical specification for the "Toody's TipSplit Deluxe" web application. It is the definitive source-of-truth for all business logic, data structures, UI behavior, and feature requirements. During refactoring, any ambiguity in the original source code should be resolved by adhering to the specifications outlined here. The goal is to modernize the codebase while preserving 100% of the existing functionality.
0.2. Primary Refactoring Goals
1.	Separation of Concerns: Deconstruct the single index.html file. 
o	HTML should be in index.html.
o	CSS should be in a separate styles.css file.
o	JavaScript should be in a separate app.js file (or multiple modules).
2.	Modularity: Break down the monolithic JavaScript logic into smaller, maintainable modules. Suggested modules: 
o	state.js: To manage the application's state (employeeRoster, dailyShifts) and interactions with localStorage.
o	ui.js: For all functions that render or manipulate the DOM (e.g., renderEmployeeRoster, renderDailyPayoutResults).
o	calculations.js: For pure business logic, including runTipAndWageCalculationsForDay and its helper functions.
o	events.js: To attach all event listeners and handle user interactions.
o	main.js or app.js: The entry point that initializes the application and orchestrates the other modules.
3.	State Management: Move away from global variables. Encapsulate the application state within the state.js module and provide getter/setter functions to access and modify it.
4.	Readability: Improve code clarity with descriptive variable names, consistent formatting, and JSDoc-style comments for complex functions.
________________________________________
1. Data Models & State Management
1.1. Core State
The application's entire state must be derivable from two primary data structures.
JavaScript
// state.js
let state = {
    employeeRoster: [], // Array of employee objects
    dailyShifts: {}     // Object mapping dates to arrays of shift objects
};
1.2. employeeRoster Data Structure
This is an array of employee objects. Each object must conform to the following schema:
JavaScript
{
  "id": "string", // A unique identifier generated by `generateId()`
  "name": "string", // Employee's full name, e.g., "Fonzie"
  "positions": ["string"], // An array of job titles from the `JOB_POSITIONS_AVAILABLE` constant
  "payRates": { // An object mapping position to hourly pay rate
    "Server": "number", // e.g., 15.50
    "Shake Spinner": "number" // e.g., 12.00
  }
}
1.3. dailyShifts Data Structure
This is an object where keys are date strings in "YYYY-MM-DD" format and values are arrays of shift objects. Each shift object must conform to the following schema:
JavaScript
{
  "id": "string", // A unique identifier generated by `generateId()`
  "date": "string", // The date of the shift in "YYYY-MM-DD" format
  "employeeId": "string", // Corresponds to the `id` in the employeeRoster
  "employeeName": "string", // Employee's name at the time of logging
  "positionWorked": "string", // The specific position for this shift
  "shiftPayRate": "number", // The hourly pay rate for this specific shift
  "timeIn": "string", // Clock-in time in "HH:MM" (24-hour) format
  "timeOut": "string", // Clock-out time in "HH:MM" (24-hour) format
  // The following keys are required ONLY if positionWorked is "Server"
  "totalSales": "number",
  "ccTips": "number",
  "cashTips": "number"
}
1.4. Persistence
•	The employeeRoster array must be saved to localStorage under the key dinerTipSplit_employeeRosterV2.
•	The dailyShifts object must be saved to localStorage under the key dinerTipSplit_dailyShiftsV2.
•	A saveState() function must be called after any modification to these data structures to ensure persistence.
________________________________________
2. Core Calculation Engine & Business Logic
The function runTipAndWageCalculationsForDay contains the application's core business logic. It must not be altered.
•	Input: An array of raw shift objects for a single day.
•	Output: An array of "processed" shift objects, each augmented with the following calculated keys: hoursWorked, shiftWage, tipOutGiven, tipInReceived, detailedTipIns, tipsForTaxes, tipsOnCheck, totalPayoutOnCheck, finalTakeHomeTips.
2.1. Calculation Rules (Must be preserved exactly)
1.	Time Rounding for Overlap: For calculating tip-outs, shift times are rounded to the nearest 15-minute interval (roundToNearest15Minutes).
2.	Overlap Calculation: Proration is based on the exact number of overlapping minutes between a Server's shift and a Support role's shift, using the rounded times (calculateOverlapDurationMinutes).
3.	Tip-Out Formulas: 
o	Busser: (Server Sales * 0.015) * (Overlap Minutes / Server's Total Shift Minutes)
o	Food Runner: (Server Sales * 0.010) * (Overlap Minutes / Server's Total Shift Minutes)
o	Shake Spinner: (Server Sales * 0.010) * (Overlap Minutes / Server's Total Shift Minutes)
o	Host: Flat $5.00 from a Server if Overlap Minutes > 0.
4.	Final Amount Rounding: The calculated tip-out amount for each support person from each server is rounded to the nearest half-dollar (roundToNearestHalfDollar).
________________________________________
3. UI Components & DOM Identifiers
This section maps logical components to their essential HTML ids and classes. These identifiers must be maintained for the JavaScript to function correctly.
Component / View	Key HTML Element(s)	Description
Global Date Controls	.top-date-controls, #cycleStartDateSelect, #weekInCycleSelect	Master controls for setting the application's date context.
Employee Mgmt View	#employeeFormSection, #addEmployeeFormWrapper, #fullEmployeeRosterContainer	The screen for all CRUD operations on employees.
Shift Logging View	#employeeLineupSection, #rosterListContainer, .roster-position-group	The main daily-use screen for logging and editing shifts.
Inline Shift Form	.inline-shift-form-container, .log-specific-shift-btn	The dynamic form that appears within a list item for shift entry.
Daily Report View	#payoutSection, #payoutResults, .data-results-table	Displays the results of the daily tip calculations.
Weekly Report View	#weeklyReportSection, #reportOutput, #exportWeeklyCSVBtn	Displays weekly aggregate and daily breakdown reports.
Data Mgmt View	#dataManagementSection, #downloadStateBtn, #loadStateFile	Contains controls for backing up and restoring all application data.
Tutorial System	#tutorial-overlay, #tutorial-highlight-box, #tutorial-text-box	The fixed-position elements that compose the interactive tutorial.
________________________________________
4. System Behaviors & Dynamic UI Changes
This section defines the required dynamic interactions of the UI.
4.1. Collapsible Sections (.collapsible-header)
•	Trigger: A click on any element with the .collapsible-header class.
•	Required Actions: 
1.	Toggle the display style of the associated .collapsible-content div between block and none.
2.	Toggle the textContent of the .collapse-indicator span between + and -.
3.	Toggle the aria-expanded attribute on the header between "true" and "false".
4.	Save the new state (true for collapsed, false for expanded) to localStorage using a key pattern like collapsible_[contentId]_collapsed.
5.	When a section is expanded, if it's a report section (payoutSection or weeklyReportSection), its content must be immediately recalculated and re-rendered.
4.2. Shift Logging Flow (in #employeeLineupSection)
The UI for each employee list item must cycle through these states:
1.	Initial State: 
o	The .worked-today-toggle-btn button shows "Log Shift" and has the .is-not-working class (gray styling).
o	The .inline-shift-form-container has display: none.
o	No .shift-summary-display is present.
2.	Form Open State (after clicking "Log Shift"): 
o	The button's text changes to "Close Shift Form" and it gets the .is-working class (purple styling).
o	The .inline-shift-form-container is populated with a form and gets display: block.
3.	Logged State (after submitting the form): 
o	The button's text changes to Edit Shift (HH:MM AM/PM) and it gets the .is-editing-shift class (red styling).
o	The .inline-shift-form-container gets display: none and its contents are cleared.
o	A new div.shift-summary-display is appended to the .employee-info div, containing a text summary of the shift (times, hours, sales, tips).
4.	Edit State (after clicking "Edit Shift"): 
o	The behavior is identical to the "Form Open State," but the form is pre-populated with the existing shift's data. Buttons for "Update Shift," "Delete Shift," and "Cancel Edit" must be present.
4.3. Edit from Weekly Report Flow
This is a critical cross-section interaction that must be preserved.
•	Trigger: Clicking an "Edit" button on a shift row within the #reportOutput table.
•	Required Actions: 
1.	The handleEditShiftFromWeeklyReport logic must execute.
2.	The main #cycleStartDateSelect and #weekInCycleSelect controls must be programmatically updated to the date of the clicked shift.
3.	All date-dependent UI elements must update accordingly.
4.	The #employeeLineupSection must be made visible and expanded if it was collapsed.
5.	The page must scroll to the specific employee's list item for that shift.
6.	The inline edit form for that shift must be automatically opened, pre-filled, and ready for editing.
________________________________________
5. Detailed Feature Specifications
5.1. Employee Roster Import
•	File Type: Must accept .txt files.
•	Format: Must parse a strict 3-line format per employee: 
1.	Line 1: Full Name
2.	Line 2: Comma-separated list of positions
3.	Line 3: Comma-separated list of corresponding pay rates
•	Logic: If an imported name matches an existing employee (case-insensitive), the system must update that employee's positions and pay rates. Otherwise, it must create a new employee.
5.2. Weekly Report & Excel Export (exportToXLSX)
•	UI Report: The weekly report in the UI must contain two parts: a summary table of weekly totals per employee, followed by day-by-day breakdown tables.
•	Excel Export: 
o	Library: Must use the SheetJS library.
o	Structure: The exported .xlsx file must be multi-tabbed: 
	A "Week Totals" tab with the summary data.
	A separate tab for each day of the week (Mon, Tue, etc.) with that day's detailed shift calculations.
o	Styling: The exported sheets must be styled for readability: 
	Header rows must have a red background (#E53935) and bold, white text.
	All cells must have thin borders.
	Data rows must have alternating background colors (zebra-striping) using white and light cream (#FFF9C4).
	Column widths should be auto-fitted to their content.
5.3. Data Backup & Restore
•	Download (downloadStateBtn): Must serialize the entire current state (employeeRoster and dailyShifts) into a single, well-formatted JSON string and trigger a browser download of a .json file.
•	Load (loadStateFile): Must present a file input that accepts .json files. Upon file selection, it must: 
1.	Display a confirmation prompt to the user warning them that their current data will be overwritten.
2.	On confirmation, parse the JSON file.
3.	Validate that the file contains the expected employeeRoster and dailyShifts keys.
4.	Completely replace the data in localStorage with the data from the file.
5.	Force a page reload to ensure the application re-initializes with the new data.
5.4. Tutorial System
•	Architecture: The tutorial steps must be defined in a configuration object (tutorials).
•	Behavior: When activated, the system must: 
1.	Display a full-page semi-transparent overlay (#tutorial-overlay).
2.	Use requestAnimationFrame to continuously position a highlight box (#tutorial-highlight-box) around the target DOM element for the current step.
3.	Automatically expand any collapsed sections to make the target element visible.
4.	For dynamic elements, programmatically click a "trigger" element to make the target appear before highlighting it.
5.	Display a text box (#tutorial-text-box) with navigation controls (Prev, Next, Close).
6.	Be dismissible with the Escape key.

